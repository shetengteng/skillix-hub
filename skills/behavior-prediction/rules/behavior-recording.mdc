---
description: 自动记录用户行为，用于行为预测 Skill
globs: ["**/*"]
alwaysApply: true
---

# 行为记录规则

## 一、动作记录

在执行以下工具调用**完成后**，自动记录动作。

### 需要记录的工具

| 工具 | 记录条件 |
|------|----------|
| Write | 总是记录 |
| StrReplace | 总是记录 |
| Delete | 总是记录 |
| Shell | 命令执行完成后记录 |

### 动作分类

请根据工具调用的语义进行分类，**不限于以下类型**：

**常见类型参考**：
- 文件操作：create_file, edit_file, delete_file
- 代码相关：write_code, write_test, refactor, fix_bug
- 命令执行：run_test, run_build, run_server, install_dep
- Git 操作：git_add, git_commit, git_push, git_pull

**分类要求**：
1. 理解语义，不只看关键词
2. 结合用户消息理解意图
3. 可以创建新类型（如 train_model, deploy_app）
4. 输出置信度

### 记录执行

工具调用完成后，执行记录脚本。脚本路径根据使用的 AI 助手自动选择：

**查找顺序**（项目级优先）：
1. `<project>/.cursor/skills/behavior-prediction/scripts/record_action.py`
2. `<project>/.claude/skills/behavior-prediction/scripts/record_action.py`
3. `<project>/.ai/skills/behavior-prediction/scripts/record_action.py`
4. `~/.cursor/skills/behavior-prediction/scripts/record_action.py`（全局）

```bash
python3 <skill_path>/scripts/record_action.py '{
  "type": "分类结果",
  "tool": "工具名称",
  "timestamp": "当前ISO8601时间",
  "details": {
    "file_path": "文件路径（如适用）",
    "command": "命令内容（如适用）",
    "exit_code": "退出码（如适用）"
  },
  "classification": {
    "confidence": 0.95,
    "is_new_type": false,
    "description": "类型描述（新类型时）"
  }
}'
```

### 记录示例

**示例 1：创建文件**

工具调用：Write("src/utils/helper.py", "...")

```bash
python3 ~/.cursor/skills/behavior-prediction/scripts/record_action.py '{
  "type": "create_file",
  "tool": "Write",
  "timestamp": "2026-01-31T10:30:00Z",
  "details": {"file_path": "src/utils/helper.py"},
  "classification": {"confidence": 0.98, "is_new_type": false}
}'
```

**示例 2：运行测试**

工具调用：Shell("pytest tests/ -v")

```bash
python3 ~/.cursor/skills/behavior-prediction/scripts/record_action.py '{
  "type": "run_test",
  "tool": "Shell",
  "timestamp": "2026-01-31T10:35:00Z",
  "details": {"command": "pytest tests/ -v", "exit_code": 0},
  "classification": {"confidence": 0.95, "is_new_type": false}
}'
```

**示例 3：新类型（机器学习训练）**

工具调用：Shell("python train.py --epochs 100")

```bash
python3 ~/.cursor/skills/behavior-prediction/scripts/record_action.py '{
  "type": "train_model",
  "tool": "Shell",
  "timestamp": "2026-01-31T10:40:00Z",
  "details": {"command": "python train.py --epochs 100", "exit_code": 0},
  "classification": {
    "confidence": 0.85,
    "is_new_type": true,
    "description": "训练机器学习模型"
  }
}'
```

## 二、预测建议

### 触发时机

在以下情况下触发预测：
1. 完成一个"重要"动作后（create_file, edit_file, write_code 等）
2. 用户明确请求预测

### 预测流程

1. **获取统计数据**：

```bash
python3 ~/.cursor/skills/behavior-prediction/scripts/get_statistics.py '{
  "current_action": "刚完成的动作类型"
}'
```

2. **分析并决策**：

根据返回的统计数据，综合判断：
- 历史概率（transitions 中的 probability）
- 样本量（count）
- 最近行为模式（recent_sequence）
- 当前上下文

3. **生成建议**（如果置信度 > 0.5）：

使用自然、友好的语言，根据置信度调整语气：
- > 0.9：肯定语气，如"我来帮你运行测试"
- 0.7-0.9：建议语气，如"要运行测试验证一下吗？"
- 0.5-0.7：询问语气，如"你可能想运行测试？"

## 三、会话结束处理（可选）

> **注意**：由于实时记录已经保证了数据完整性，会话结束处理是**可选的**。即使没有执行，数据也是完整的。

### 触发时机

**如果有机会执行**（用户等待 AI 响应后再离开）：
- 用户说"谢谢"、"好的"、"结束"、"拜拜"
- 用户说"thanks"、"done"、"bye"

### 处理内容

会话结束处理只做"锦上添花"的工作：
1. 记录会话统计
2. 验证数据一致性

```bash
python3 ~/.cursor/skills/behavior-prediction/scripts/finalize_session.py '{
  "actions_summary": [
    {"type": "create_file", "tool": "Write", "file": "..."},
    {"type": "edit_file", "tool": "StrReplace", "file": "..."},
    {"type": "run_test", "tool": "Shell", "command": "..."}
  ],
  "start_time": "会话开始时间",
  "end_time": "当前时间"
}'
```

## 四、注意事项

1. **记录失败不阻塞**：如果脚本执行失败，继续正常流程
2. **静默执行**：记录过程不向用户显示
3. **频率控制**：相同动作 5 秒内不重复记录
4. **本地存储**：所有数据存储在本地，用户完全控制
