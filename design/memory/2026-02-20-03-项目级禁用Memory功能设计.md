# 项目级禁用 Memory 功能设计

## 背景

全局安装 Memory Skill 后，`~/.cursor/hooks.json` 和 `~/.cursor/rules/memory-rules.mdc` 对所有项目生效。但某些项目可能不需要记忆功能（如临时项目、敏感项目、第三方代码审查等）。

当前版本**没有**项目级禁用机制。

---

## 现状分析

### 当前 Hook 执行流程（无禁用检查）

```
Cursor 触发 Hook
 ↓
Hook 脚本执行（无条件）
 ↓
读取/写入 memory-data
```

### 受影响的 Hook 脚本

| Hook | 脚本 | 影响 |
|------|------|------|
| sessionStart | `load_memory.py` | 创建 daily/ 目录，写入 session_start 日志 |
| preCompact | `flush_memory.py` | 创建 memory-data/ 目录，生成 [Memory Flush] 提示 |
| stop | `prompt_session_save.py` | 创建 memory-data/ 目录，生成 [Session Save] 提示 |
| sessionEnd | `sync_and_cleanup.py` | 同步索引，写入 session_end 日志 |

### 问题

在不需要记忆功能的项目中：
1. 会自动创建 `.cursor/skills/memory-data/` 目录（污染项目）
2. 每次会话都会写入日志文件
3. Agent 会收到 [Memory Flush] 和 [Session Save] 提示并执行保存操作
4. 浪费 Agent 的上下文窗口

---

## 设计方案

### `.memory-disable` 标记文件

在项目的 `.cursor/skills/` 目录下放置 `.memory-disable` 标记文件，所有 Hook 脚本在执行前检查该文件是否存在。

### 文件位置

```
<项目>/.cursor/skills/.memory-disable
```

**选择 `.cursor/skills/` 的原因**：
- 与 `memory-data/` 同级，逻辑归属清晰
- 不污染项目根目录
- `.cursor/` 目录本身就是 Cursor 配置区域，符合职责划分
- 与 Skill 代码目录（`.cursor/skills/memory/`）同级，语义上表示"禁用此 Skill"

### 作用机制

**原理**：利用文件系统的存在性检查（`os.path.exists()`）作为开关。

**工作流程**：

```
Cursor 触发 Hook（如 sessionStart）
 ↓
Hook 脚本启动
 ↓
从 event 中获取 project_path（workspace_roots[0]）
 ↓
检查 <project_path>/.cursor/skills/.memory-disable 是否存在
 ├─ 存在 → 输出空 JSON {}，立即退出（不执行任何记忆操作）
 └─ 不存在 → 继续正常执行
```

**文件内容**：只检查文件是否存在，内容无关紧要。可以是空文件，也可以写入禁用原因供人阅读。

**作用范围**：仅影响当前项目，其他项目不受影响。

**生效时机**：下一次 Hook 触发时立即生效，无需重启 Cursor。

**可逆性**：删除文件后，下一次 Hook 触发时自动恢复记忆功能。已有数据不会被删除。

**Git 管理**：`.cursor/` 目录通常在 `.gitignore` 中，标记文件默认不会提交到 Git。

### 自然语言交互

用户说"这个项目不需要记忆功能"时，Agent 执行：
```bash
mkdir -p <项目路径>/.cursor/skills && touch <项目路径>/.cursor/skills/.memory-disable
```

用户说"重新开启记忆"时，Agent 执行：
```bash
rm <项目路径>/.cursor/skills/.memory-disable
```

用户说"检查记忆是否启用"时，Agent 执行：
```bash
test -f <项目路径>/.cursor/skills/.memory-disable && echo "Memory 已禁用" || echo "Memory 已启用"
```

---

## 实现设计

### 新增函数：`is_memory_enabled()`

位置：`service/config/__init__.py`

```python
DISABLE_FILE = ".memory-disable"

def is_memory_enabled(project_path):
    """检查项目是否启用 Memory 功能。"""
    disable_file = os.path.join(project_path, ".cursor", "skills", DISABLE_FILE)
    return not os.path.exists(disable_file)
```

### Hook 脚本修改

每个 Hook 脚本在 `main()` 开头增加检查：

```python
from service.config import is_memory_enabled

project_path = get_project_path(event)
if not is_memory_enabled(project_path):
    print(json.dumps({}))
    return
```

### 受影响的文件

| 文件 | 修改内容 |
|------|---------|
| `service/config/__init__.py` | 新增 `is_memory_enabled()` |
| `hooks/load_memory.py` | main() 开头增加检查 |
| `hooks/flush_memory.py` | main() 开头增加检查 |
| `hooks/prompt_session_save.py` | main() 开头增加检查 |
| `hooks/sync_and_cleanup.py` | main() 开头增加检查 |

### SKILL.md 补充

| 用户可能的说法 | 对应操作 |
|---------------|---------|
| "这个项目不需要记忆" / "关闭记忆功能" | `mkdir -p .cursor/skills && touch .cursor/skills/.memory-disable` |
| "重新开启记忆" / "启用记忆功能" | `rm .cursor/skills/.memory-disable` |
| "检查记忆是否启用" | 检查 `.cursor/skills/.memory-disable` 文件是否存在 |

---

## 禁用后的行为

| 功能 | 禁用后行为 |
|------|-----------|
| sessionStart | 不加载记忆，不写入 session_start 日志 |
| preCompact | 不生成 [Memory Flush] 提示 |
| stop | 不生成 [Session Save] 提示 |
| sessionEnd | 不同步索引，不写入 session_end 日志 |
| 手动保存 | `save_fact.py` / `save_summary.py` 检查后拒绝写入 |
| 搜索 | `search_memory.py` 返回空结果 |
| 数据目录 | 不自动创建 |
| 已有数据 | 保留不删除，重新启用后恢复 |
