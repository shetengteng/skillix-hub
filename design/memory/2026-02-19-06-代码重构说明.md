# 代码重构说明

> 日期：2026-02-19  
> 目标：按业务模块分包到 scripts/service/；配置和日志归入 service；统一日志目录

---

## 1. 重构内容

| 变更 | 说明 |
|------|------|
| 入口脚本归入 service/ | 11 个散落在 scripts/ 根的脚本按业务分组到 hooks/init/memory/manage |
| config 整体迁入 service/config | defaults.py（原 core/config.py）+ manager.py + __init__.py 统一到 service/config/ |
| logger 迁入 service/logger | logger.py（原 core/logger.py）+ __init__.py 归入 service/logger/ |
| 去除向后兼容常量 | 删除 LOAD_DAYS_FULL 等模块级重导出，使用 _DEFAULTS 直接访问 |
| 日志统一到 memory-data | 日志输出到 memory-data/logs/，与数据统一 |
| 清理 __init__.py | 删除所有空的 __init__.py（Python 3 namespace packages） |
| 测试去重 | 删除重复的 test_hooks.py，合并 ts_id 测试 |

---

## 2. 最终结构

```
scripts/
├── core/                              纯基础设施（无业务逻辑）
│   ├── utils.py               (46)    时间/ID 工具
│   ├── embedding.py           (94)    嵌入模型 + 向量生成
│   └── file_lock.py           (72)    文件互斥锁
│
├── storage/                           数据存储层
│   ├── sqlite_store.py       (168)    SQLite CRUD + schema
│   ├── sqlite_search.py      (110)    FTS5 / 向量搜索
│   ├── jsonl.py              (165)    JSONL 读取 + 衰减策略
│   ├── jsonl_manage.py       (188)    JSONL 管理（软删除/恢复/审计）
│   └── chunker.py             (47)    Markdown 文本分块
│
└── service/                           业务逻辑
    ├── config/                        配置服务
    │   ├── __init__.py        (25)    get_config / get_memory_dir / 常量重导出
    │   ├── defaults.py       (150)    _DEFAULTS / _SCHEMA / 文件名常量
    │   └── manager.py        (202)    Config 分层加载器
    │
    ├── logger/                        日志服务
    │   ├── __init__.py          (2)   get_logger 导出
    │   └── logger.py          (127)   日志器（→ memory-data/logs/）
    │
    ├── hooks/                         Cursor Hook 入口
    │   ├── load_memory.py    (112)    sessionStart
    │   ├── flush_memory.py    (71)    preCompact
    │   ├── prompt_session_save.py (83) stop
    │   └── sync_and_cleanup.py (119)  sessionEnd
    │
    ├── init/                          初始化/安装
    │   ├── index.py          (114)    安装主入口
    │   └── helpers.py        (148)    安装辅助函数
    │
    ├── memory/                        记忆操作
    │   ├── save_fact.py       (68)    事实保存 CLI
    │   ├── save_summary.py    (68)    摘要保存 CLI
    │   ├── search_memory.py   (96)    语义搜索
    │   └── sync_index.py     (206)    JSONL → SQLite 增量同步
    │
    └── manage/                        管理工具
        ├── index.py          (160)    管理主入口
        └── commands/                  子命令模块
            ├── _helpers.py   (109)    公共函数
            ├── cmd_list.py   (144)    list + stats
            ├── cmd_delete.py (126)    delete + restore
            ├── cmd_edit.py   (161)    edit + export + cleanup
            ├── cmd_index.py  (142)    rebuild-index + doctor
            └── cmd_config.py  (62)    config 子命令
```

**总计：30 个 Python 文件，全部 < 220 行。**

---

## 3. 包职责划分

| 包 | 职责 | 模块数 |
|----|------|--------|
| `core/` | 纯工具函数、嵌入模型、文件锁（无配置/日志依赖） | 3 |
| `storage/` | SQLite 存储/搜索、JSONL 读写/管理、分块 | 5 |
| `service/config/` | 默认值定义 + Config 分层加载 + 便捷访问函数 | 3 |
| `service/logger/` | 统一日志器（按天轮转、memory-data/logs/） | 2 |
| `service/hooks/` | 4 个 Cursor Hook 入口 | 4 |
| `service/init/` | 初始化安装 | 2 |
| `service/memory/` | 记忆操作 CLI | 4 |
| `service/manage/` | 管理工具 + 7 子命令 | 7 |

---

## 4. 配置体系

### service/config/ 三文件分工

| 文件 | 职责 |
|------|------|
| `defaults.py` | _DEFAULTS 定义、_SCHEMA 校验规则、文件名常量、工具函数 |
| `manager.py` | Config 分层加载器（默认值 → 全局配置 → 项目配置 → 环境变量） |
| `__init__.py` | 对外统一入口：re-export 所有常量 + get_config / get_memory_dir |

### 调用方式

```python
from service.config import _DEFAULTS, MEMORY_MD, get_config, get_memory_dir
cfg = get_config(project_path)
days = cfg.get("memory.load_days_full")
```

---

## 5. 导入规则

### sys.path 统一指向 scripts/

| 位置 | 路径计算 |
|------|---------|
| `service/hooks/*.py` | `dirname + "../.."` |
| `service/manage/commands/*.py` | `dirname + "../../.."` |
| `service/init/index.py` | `dirname + "../.."` |

### 导入来源

| 内容 | 来源 |
|------|------|
| `_DEFAULTS`, `_SCHEMA`, `MEMORY_MD`, `SESSIONS_FILE` 等 | `service.config` |
| `get_config`, `get_memory_dir`, `get_daily_dir` | `service.config` |
| `Config` | `service.config` 或 `service.config.manager` |
| `get_logger` | `service.logger` |
| `utcnow`, `iso_now`, `ts_id` | `core.utils` |
| `embed_text`, `is_available` | `core.embedding` |
| `FileLock` | `core.file_lock` |
| `SQLiteStore`, `read_jsonl` | `storage.*` |

---

## 6. 测试文件

```
tests/standalone-memory/
├── run_tests.py        # 统一执行器 + MD 报告
├── test_common.py      # 共享工具
├── test_chunker.py     # 分块策略
├── test_config.py      # 配置管理
├── test_context_flow.py # 上下文生命周期
├── test_e2e.py         # 端到端
├── test_hook_contracts.py # Hook 契约
├── test_init.py        # 初始化
├── test_install_paths.py # 安装路径
├── test_jsonl.py       # JSONL 读写
├── test_regression.py  # 回归测试
├── test_sqlite.py      # SQLite 存储
├── test_sync_search.py # 同步/搜索
└── test_unit_core.py   # 核心单元
```

**29 个用例，27 通过 + 2 跳过。**

---

## 7. 验证结果

- 全部 30 个源码文件 < 220 行
- core/ 精简为 3 个纯工具模块（无业务逻辑）
- service/ 包含 8 个子包，覆盖配置、日志、Hook、初始化、记忆操作、管理工具
- 所有 Hook / CLI / 管理子命令运行正常
- 测试全通过（2 个待实现功能已标记 skip）
