# 统一配置入口设计

> 日期：2026-02-19  
> 背景：当前所有参数硬编码在 `lib/config.py`，用户无法自定义衰减策略、模型选择、日志级别等行为。需要一个用户可调整的配置体系。

---

## 1. 问题分析

### 当前状态

所有配置写死在 `lib/config.py`：

| 类别 | 参数 | 当前值 | 用户可调？ |
|------|------|--------|-----------|
| 衰减策略 | LOAD_DAYS_FULL | 2 | 否 |
| 衰减策略 | LOAD_DAYS_PARTIAL | 5 | 否 |
| 衰减策略 | LOAD_DAYS_MAX | 7 | 否 |
| 衰减策略 | LOAD_PARTIAL_PER_DAY | 3 | 否 |
| 衰减策略 | LOAD_IMPORTANT_CONFIDENCE | 0.9 | 否 |
| 衰减策略 | LOAD_FACTS_LIMIT | 15 | 否 |
| 分块 | CHUNK_TOKENS | 400 | 否 |
| 分块 | CHUNK_OVERLAP | 80 | 否 |
| 模型 | DEFAULT_EMBEDDING_MODEL | BAAI/bge-small-zh-v1.5 | 否 |
| 模型 | GLOBAL_MODEL_CACHE | ~/.memory/models | 否 |
| 日志 | LOG_RETAIN_DAYS | 7 | 否 |
| 日志 | LOG_LEVEL | INFO | 仅环境变量 |
| 路径 | MEMORY_DIR_NAME | .cursor/skills/memory-data | 否 |

### 痛点

1. **用户无法调整记忆行为**：想多记 30 天而不是 7 天？必须改源码
2. **项目间配置无法差异化**：A 项目想加载更多记忆，B 项目想更少
3. **升级时配置丢失**：更新 Skill 代码会覆盖用户的 `config.py` 修改
4. **自然语言配置不可达**：用户说"记忆保留时间改长一点"，Agent 无法操作

---

## 2. 设计目标

1. 用户通过**自然语言**或**配置文件**自定义行为
2. 配置与代码分离，升级 Skill 不丢失配置
3. 支持多级配置：全局默认 → 项目级 → 环境变量覆盖
4. Agent 可代用户读写配置

---

## 3. 配置文件设计

### 3.1 文件位置与优先级

```
优先级（高 → 低）：

1. 环境变量        MEMORY_LOG_LEVEL=DEBUG
2. 项目级配置      .cursor/skills/memory-data/config.json
3. 全局配置        ~/.memory/config.json
4. 代码默认值      lib/config.py 中的常量
```

高优先级覆盖低优先级，未设置的字段回退到下一级。

### 3.2 文件格式

JSON，与现有工具输出一致。

### 3.3 配置文件结构

```json
{
  "version": 1,

  "memory": {
    "load_days_full": 2,
    "load_days_partial": 5,
    "load_days_max": 7,
    "partial_per_day": 3,
    "important_confidence": 0.9,
    "facts_limit": 15
  },

  "embedding": {
    "model": "BAAI/bge-small-zh-v1.5",
    "cache_dir": "~/.memory/models"
  },

  "index": {
    "chunk_tokens": 400,
    "chunk_overlap": 80
  },

  "log": {
    "level": "INFO",
    "retain_days": 7
  },

  "paths": {
    "data_dir": ".cursor/skills/memory-data"
  },

  "cleanup": {
    "auto_cleanup_days": 90,
    "backup_retain_days": 30
  }
}
```

### 3.4 字段详细说明

#### memory — 记忆加载衰减策略

| 字段 | 类型 | 默认值 | 说明 | 约束 |
|------|------|--------|------|------|
| `load_days_full` | int | 2 | 最近 N 天加载全部事实 | ≥1 |
| `load_days_partial` | int | 5 | N+1 ~ M 天前每天部分加载 | > load_days_full |
| `load_days_max` | int | 7 | M+1 ~ K 天前仅加载高置信度 | > load_days_partial |
| `partial_per_day` | int | 3 | 部分加载时每天最多几条 | ≥1 |
| `important_confidence` | float | 0.9 | 高置信度阈值 | 0.0 ~ 1.0 |
| `facts_limit` | int | 15 | 加载事实总上限 | ≥1 |

**用户场景**：
- "记忆太少了" → 增大 `load_days_full`、`facts_limit`
- "加载太慢了" → 减小 `load_days_max`、`facts_limit`
- "只要最近的" → `load_days_full=1, load_days_max=3`

#### embedding — 嵌入模型

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `model` | string | "BAAI/bge-small-zh-v1.5" | SentenceTransformer 模型名 |
| `cache_dir` | string | "~/.memory/models" | 模型缓存目录 |

**用户场景**：
- "换个更好的模型" → 修改 `model` 为 Qwen3-Embedding-0.6B
- "模型放到其他位置" → 修改 `cache_dir`

**注意**：更换模型后需要 `rebuild-index --full` 重建索引。

#### index — 文本分块

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `chunk_tokens` | int | 400 | 每块最大 token 数 |
| `chunk_overlap` | int | 80 | 相邻块重叠 token |

#### log — 日志

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `level` | string | "INFO" | 日志级别：DEBUG/INFO/WARNING/ERROR |
| `retain_days` | int | 7 | 日志保留天数 |

#### paths — 路径

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `data_dir` | string | ".cursor/skills/memory-data" | 数据目录（相对项目根） |

#### cleanup — 清理策略

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `auto_cleanup_days` | int | 90 | 自动清理 N 天前的 daily 数据（0=不自动清理） |
| `backup_retain_days` | int | 30 | 自动备份保留天数 |

---

## 4. 配置加载机制

### 4.1 加载流程

```
lib/config.py 启动
    ↓
加载代码默认值（_DEFAULTS 字典）
    ↓
检查全局配置 ~/.memory/config.json
    ↓ 存在则合并（deep merge）
检查项目配置 {project}/.cursor/skills/memory-data/config.json
    ↓ 存在则合并（deep merge）
检查环境变量 MEMORY_*
    ↓ 存在则覆盖对应字段
最终配置就绪
```

### 4.2 环境变量映射

| 环境变量 | 对应字段 |
|---------|---------|
| `MEMORY_LOG_LEVEL` | log.level |
| `MEMORY_LOAD_DAYS_FULL` | memory.load_days_full |
| `MEMORY_LOAD_DAYS_MAX` | memory.load_days_max |
| `MEMORY_FACTS_LIMIT` | memory.facts_limit |
| `MEMORY_EMBEDDING_MODEL` | embedding.model |
| `MEMORY_DATA_DIR` | paths.data_dir |

命名规则：`MEMORY_` + 字段名大写 + 下划线分隔。

### 4.3 配置校验

加载时进行类型和范围校验：

```python
SCHEMA = {
    "memory.load_days_full": {"type": int, "min": 1, "max": 365},
    "memory.load_days_partial": {"type": int, "min": 1, "max": 365},
    "memory.load_days_max": {"type": int, "min": 1, "max": 365},
    "memory.partial_per_day": {"type": int, "min": 1, "max": 100},
    "memory.important_confidence": {"type": float, "min": 0.0, "max": 1.0},
    "memory.facts_limit": {"type": int, "min": 1, "max": 500},
    "index.chunk_tokens": {"type": int, "min": 50, "max": 2000},
    "index.chunk_overlap": {"type": int, "min": 0, "max": 500},
    "log.level": {"type": str, "enum": ["DEBUG", "INFO", "WARNING", "ERROR"]},
    "log.retain_days": {"type": int, "min": 1, "max": 365},
}
```

校验失败时：记录 warning 日志 + 使用默认值（不中断运行）。

### 4.4 逻辑约束

| 约束 | 说明 |
|------|------|
| `load_days_full < load_days_partial` | 全量天数必须小于部分天数 |
| `load_days_partial < load_days_max` | 部分天数必须小于最大天数 |
| `chunk_overlap < chunk_tokens` | 重叠不能超过块大小 |

违反约束时：warning + 自动修正（如取 min/max 边界）。

---

## 5. 用户交互设计

### 5.1 通过自然语言配置

用户不需要知道配置文件的存在，直接对 Agent 说：

| 用户说 | Agent 操作 |
|--------|-----------|
| "记忆保留改成 30 天" | 修改 `memory.load_days_max = 30` |
| "加载更多记忆" | 增大 `memory.facts_limit` 和 `memory.load_days_max` |
| "只要最近 1 天的记忆" | 设 `load_days_full=1, load_days_max=1` |
| "换成 Qwen 嵌入模型" | 修改 `embedding.model` + 提示需要 rebuild-index |
| "看看当前配置" | 调用 `manage_memory.py config show` |
| "日志级别改成 DEBUG" | 修改 `log.level = "DEBUG"` |

### 5.2 manage_memory.py 增加 `config` 子命令

```bash
# 查看当前生效配置（合并后的最终结果）
manage_memory.py config show

# 查看某个字段
manage_memory.py config get memory.facts_limit

# 修改项目级配置
manage_memory.py config set memory.facts_limit 30

# 修改全局配置
manage_memory.py config set --global memory.facts_limit 30

# 重置为默认值
manage_memory.py config reset memory.facts_limit

# 重置所有配置
manage_memory.py config reset --all

# 验证配置文件
manage_memory.py config validate
```

### 5.3 config show 输出

```json
{
  "status": "ok",
  "command": "config show",
  "data": {
    "effective": {
      "memory": {
        "load_days_full": 2,
        "load_days_partial": 5,
        "load_days_max": 30,
        "partial_per_day": 3,
        "important_confidence": 0.9,
        "facts_limit": 15
      },
      "embedding": {
        "model": "BAAI/bge-small-zh-v1.5",
        "cache_dir": "~/.memory/models"
      },
      "index": {
        "chunk_tokens": 400,
        "chunk_overlap": 80
      },
      "log": {
        "level": "INFO",
        "retain_days": 7
      },
      "paths": {
        "data_dir": ".cursor/skills/memory-data"
      },
      "cleanup": {
        "auto_cleanup_days": 90,
        "backup_retain_days": 30
      }
    },
    "sources": {
      "memory.load_days_max": "project",
      "log.level": "env:MEMORY_LOG_LEVEL"
    }
  }
}
```

`sources` 字段标注非默认值的来源，Agent 可以告诉用户："记忆保留天数是 30 天（项目配置），日志级别是 DEBUG（环境变量）。"

### 5.4 config set 输出

```json
{
  "status": "ok",
  "command": "config set",
  "data": {
    "field": "memory.facts_limit",
    "old_value": 15,
    "new_value": 30,
    "scope": "project",
    "file": ".cursor/skills/memory-data/config.json",
    "needs_rebuild": false
  }
}
```

需要重建索引的字段变更时：

```json
{
  "status": "ok",
  "command": "config set",
  "data": {
    "field": "embedding.model",
    "old_value": "BAAI/bge-small-zh-v1.5",
    "new_value": "Qwen/Qwen3-Embedding-0.6B",
    "scope": "project",
    "needs_rebuild": true,
    "rebuild_reason": "嵌入模型变更后需要重建索引以匹配新向量维度"
  }
}
```

Agent 收到 `needs_rebuild=true` 后提示用户是否重建。

---

## 6. Agent 行为规范

### 6.1 查看配置

```
用户: "看看记忆配置"
Agent:
  1. 调用 manage_memory.py config show
  2. 提取关键信息，用自然语言展示：
     "当前配置：
      - 加载最近 2 天全部记忆，3~5 天部分加载，最远 7 天
      - 每次最多加载 15 条事实
      - 嵌入模型：BGE-small-zh-v1.5
      - 日志保留 7 天"
```

### 6.2 修改配置

```
用户: "记忆保留改成 30 天"
Agent:
  1. 理解为 load_days_max = 30
  2. 调用 manage_memory.py config set memory.load_days_max 30
  3. 检查 needs_rebuild
  4. 回复："已将记忆最大保留天数从 7 天改为 30 天。"
```

### 6.3 模糊请求处理

```
用户: "记忆加载多一些"
Agent:
  1. 调用 config show 查看当前值
  2. 判断可调字段：facts_limit(15→30), load_days_full(2→3)
  3. 向用户确认："建议将加载上限从 15 条改为 30 条，最近全量天数从 2 天改为 3 天，可以吗？"
  4. 用户确认后执行两次 config set
```

### 6.4 危险配置警告

```
用户: "记忆保留 365 天"
Agent:
  1. 执行 config set
  2. 警告："已设置，但 365 天的数据量可能影响加载速度，建议同时增大 facts_limit。"
```

---

## 7. 实现方案

### 7.1 config.py 改造

当前 `config.py` 是纯常量模块。改造为配置加载器：

```python
_DEFAULTS = {
    "memory": {
        "load_days_full": 2,
        "load_days_partial": 5,
        "load_days_max": 7,
        "partial_per_day": 3,
        "important_confidence": 0.9,
        "facts_limit": 15,
    },
    "embedding": {
        "model": "BAAI/bge-small-zh-v1.5",
        "cache_dir": "~/.memory/models",
    },
    "index": {
        "chunk_tokens": 400,
        "chunk_overlap": 80,
    },
    "log": {
        "level": "INFO",
        "retain_days": 7,
    },
    "paths": {
        "data_dir": ".cursor/skills/memory-data",
    },
    "cleanup": {
        "auto_cleanup_days": 90,
        "backup_retain_days": 30,
    },
}

class Config:
    """分层配置加载器"""

    def __init__(self, project_path=None):
        self._config = deep_copy(_DEFAULTS)
        self._sources = {}  # 记录每个字段来源

        # 层级 1：全局配置
        global_cfg = self._load_json("~/.memory/config.json")
        if global_cfg:
            self._merge(global_cfg, source="global")

        # 层级 2：项目配置
        if project_path:
            proj_cfg = self._load_json(
                os.path.join(project_path, _DEFAULTS["paths"]["data_dir"], "config.json")
            )
            if proj_cfg:
                self._merge(proj_cfg, source="project")

        # 层级 3：环境变量
        self._apply_env_overrides()

        # 校验
        self._validate()

    def get(self, dotpath: str, default=None):
        """获取配置值，如 get("memory.facts_limit")"""
        ...

    def set(self, dotpath: str, value, scope="project"):
        """设置配置值并持久化到对应 scope 的文件"""
        ...
```

### 7.2 向后兼容

改造后保留全局常量别名，现有代码无需批量改动：

```python
cfg = Config()

LOAD_DAYS_FULL = cfg.get("memory.load_days_full")
LOAD_DAYS_PARTIAL = cfg.get("memory.load_days_partial")
LOAD_DAYS_MAX = cfg.get("memory.load_days_max")
LOAD_PARTIAL_PER_DAY = cfg.get("memory.partial_per_day")
LOAD_IMPORTANT_CONFIDENCE = cfg.get("memory.important_confidence")
LOAD_FACTS_LIMIT = cfg.get("memory.facts_limit")
CHUNK_TOKENS = cfg.get("index.chunk_tokens")
CHUNK_OVERLAP = cfg.get("index.chunk_overlap")
DEFAULT_EMBEDDING_MODEL = cfg.get("embedding.model")
GLOBAL_MODEL_CACHE = os.path.expanduser(cfg.get("embedding.cache_dir"))
LOG_RETAIN_DAYS = cfg.get("log.retain_days")
LOG_LEVEL = cfg.get("log.level")
MEMORY_DIR_NAME = cfg.get("paths.data_dir")
```

所有 `from lib.config import LOAD_DAYS_FULL` 的引用无需修改。

### 7.3 manage_memory.py 增加 config 子命令

```python
def cmd_config(args):
    if args.action == "show":
        return config_show(args)
    elif args.action == "get":
        return config_get(args)
    elif args.action == "set":
        return config_set(args)
    elif args.action == "reset":
        return config_reset(args)
    elif args.action == "validate":
        return config_validate(args)
```

### 7.4 init.py 更新

初始化时生成**包含完整默认值**的配置文件，用户打开即可看到所有可配置项：

```python
config_json = os.path.join(memory_dir, "config.json")
if not os.path.exists(config_json):
    from lib.config import _DEFAULTS
    default_config = copy.deepcopy(_DEFAULTS)
    default_config["version"] = 1
    with open(config_json, "w", encoding="utf-8") as f:
        json.dump(default_config, f, indent=2, ensure_ascii=False)
```

生成的 `config.json` 内容示例：

```json
{
  "memory": {
    "load_days_full": 2,
    "load_days_partial": 5,
    "load_days_max": 7,
    "partial_per_day": 3,
    "important_confidence": 0.9,
    "facts_limit": 15
  },
  "embedding": {
    "model": "BAAI/bge-small-zh-v1.5",
    "cache_dir": "~/.memory/models"
  },
  "index": {
    "chunk_tokens": 400,
    "chunk_overlap": 80
  },
  "log": {
    "level": "INFO",
    "retain_days": 7
  },
  "paths": {
    "data_dir": ".cursor/skills/memory-data"
  },
  "cleanup": {
    "auto_cleanup_days": 90,
    "backup_retain_days": 30
  },
  "version": 1
}
```

用户直接编辑文件或通过 Agent 自然语言修改均可。已有 `config.json` 不会被覆盖。

---

## 8. 需要重建索引的配置变更

| 字段 | 原因 |
|------|------|
| `embedding.model` | 不同模型的向量维度不同 |
| `index.chunk_tokens` | 分块大小影响所有 chunk |
| `index.chunk_overlap` | 重叠大小影响所有 chunk |

Agent 收到 `needs_rebuild=true` 后行为：
```
Agent: "已更换嵌入模型为 Qwen3-Embedding-0.6B。
        由于模型变更，需要重建搜索索引，是否现在执行？（约需 30 秒）"
用户: "好"
Agent: 调用 manage_memory.py rebuild-index --full
Agent: "索引重建完成。"
```

---

## 9. 配置预设

提供几组预设配置，方便用户快速选择：

### 9.1 轻量模式（适合小项目）

```json
{
  "memory": {
    "load_days_full": 1,
    "load_days_max": 3,
    "facts_limit": 10
  },
  "cleanup": {
    "auto_cleanup_days": 30
  }
}
```

### 9.2 深度记忆模式（适合长期项目）

```json
{
  "memory": {
    "load_days_full": 5,
    "load_days_partial": 15,
    "load_days_max": 30,
    "partial_per_day": 5,
    "facts_limit": 50
  }
}
```

### 9.3 高性能模式（最小化加载开销）

```json
{
  "memory": {
    "load_days_full": 1,
    "load_days_max": 1,
    "facts_limit": 5
  },
  "log": {
    "level": "WARNING"
  }
}
```

```bash
# Agent 可以应用预设
manage_memory.py config preset deep-memory
manage_memory.py config preset lightweight
manage_memory.py config preset performance
```

---

## 10. 验收标准

| # | 标准 |
|---|------|
| 1 | 无 config.json 时使用默认值，功能不受影响 |
| 2 | 项目级 config.json 覆盖全局配置 |
| 3 | 环境变量覆盖文件配置 |
| 4 | config set 后无需重启即生效（下次 Hook 触发时） |
| 5 | 非法配置值不中断运行（warning + fallback） |
| 6 | 更换 embedding model 后提示 rebuild |
| 7 | config show 显示每个非默认值的来源 |
| 8 | init.py 创建空配置文件不覆盖已有配置 |

---

## 11. 实施优先级

### 第一批（基础）

| # | 内容 | 说明 |
|---|------|------|
| 1 | Config 类 + 分层加载 | config.py 改造 |
| 2 | 向后兼容别名 | 现有代码不改 |
| 3 | config show / get / set | manage_memory.py 子命令 |
| 4 | init.py 生成空配置文件 | 初始化支持 |
| 5 | SKILL.md 配置指导 | Agent 知道怎么操作 |

### 第二批（增强）

| # | 内容 |
|---|------|
| 6 | config validate + 约束校验 |
| 7 | config reset |
| 8 | needs_rebuild 检测 |
| 9 | 预设配置 (preset) |

### 第三批（完善）

| # | 内容 |
|---|------|
| 10 | 环境变量完整映射 |
| 11 | 配置变更日志 |
