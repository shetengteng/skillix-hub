# 测试代码整合重构说明

> 日期：2026-02-19  
> 范围：将 `skills/memory/tests` 测试体系迁移并整合到 `tests/standalone-memory`

---

## 1. 重构目标

本次重构主要解决两件事：

1. 去除 `skills` 目录内分散测试入口
2. 将测试统一收口到 `tests/standalone-memory`，形成单一执行入口与统一报告输出

---

## 2. 目录整合结果

## 2.1 迁移前

- `skills/memory/tests/*`（legacy 测试）
- `tests/standalone-memory/*`（外部独立测试）

## 2.2 迁移后

```text
tests/standalone-memory/
├── run_tests.py                       # 统一总入口（单套件）
├── test_common.py
├── test_unit_behavior.py
├── test_hook_contracts.py
├── test_e2e_flow.py
├── test_install_path_logic.py
├── test_config_entrypoints.py
├── test_detail_jsonl.py
├── test_detail_sqlite.py
├── test_detail_chunk.py
├── test_detail_load_and_hooks.py
├── test_detail_sync_and_search.py
├── test_detail_init.py
├── test_detail_context_flow.py
├── test_detail_regression.py
├── reports/
│   └── 2026-02-19-06-standalone-tests.md
└── testdata/runtime/.gitkeep
```

`skills/memory/tests` 目录已去除。

---

## 3. 关键改动说明

## 3.1 统一入口重写

文件：`tests/standalone-memory/run_tests.py`

改动点：

1. 统一执行 standalone 根目录下 `test_*.py`
2. 输出单份 Markdown 报告
3. 无子套件、无二级测试目录

## 3.2 细粒度测试保留与重组

文件：`tests/standalone-memory/test_detail_*.py`

改动点：

1. 将原 legacy 的细粒度能力按主题拆成多文件（不是单文件合并）
2. 重点保留：JSONL/SQLite/chunk/load/hooks/sync/search/init/context/regression 的细节断言
3. 删除 `test_legacy_*.py`、`run_legacy_tests.py`、`legacy_test_helper.py`

## 3.3 standalone 命名与报告收敛

已完成：

- 去除重复入口与旧编号命名冲突
- 报告统一归档到 `reports/`
- 仅保留最新报告：`2026-02-19-06-standalone-tests.md`

---

## 4. 当前测试状态（整合后）

当前状态：

1. 目录整合已完成：所有测试 `.py` 均在 `tests/standalone-memory` 同一层
2. 重复测试文件已去除：不再保留 legacy 前缀分支与二套运行器
3. 细节测试已回补：按主题保留多份细粒度 test 文件，不再“删到只剩粗粒度”
4. 因你要求“先停止测试”，本轮仅完成代码整合，不新增执行结果

---

## 5. 影响与收益

## 收益

1. 测试入口单一化：后续只需维护 `tests/standalone-memory/run_tests.py`
2. 文件组织单层化：测试文件无 legacy 子目录分叉
3. 覆盖能力整合化：历史细节校验点已按主题重组为多份详细测试文件

## 影响

1. 细粒度文件数量较多，后续可在稳定后按模块再次适度合并
2. 配置相关遗漏（`reset --all`、`facts_limit` 生效）仍建议后续修复

---

## 6. 后续建议

1. 先修复 modern 暴露的 2 个配置问题
2. 修复后将 `test_config_entrypoints.py` 失败项转为通过
3. 在代码重构稳定后，逐步把 legacy 用例迁移为 unittest 风格，最终收敛为单框架

---

## 7. 当前各测试 py 含义

为避免“文件名在但职责不清”，这里明确每个 `.py` 的用途：

1. `run_tests.py`  
   统一执行入口。负责收集 `test_*.py`（排除 `test_common.py`）、执行测试、生成 `reports/*.md` 报告。

2. `test_common.py`  
   测试基础设施。提供隔离工作区（`IsolatedWorkspaceCase`）与脚本调用工具（`run_script`），保证测试不污染真实数据。

3. `test_unit_behavior.py`  
   核心单元行为测试。覆盖 `ts_id` 唯一性、衰减加载取样逻辑、`save_fact.py` 的输出结构等。

4. `test_hook_contracts.py`  
   Hook 契约测试。校验 `load_memory.py` / `flush_memory.py` / `prompt_session_save.py` 的输入输出协议是否符合预期。

5. `test_e2e_flow.py`  
   端到端主流程测试。覆盖“写入事实 -> sessionStart 加载 -> sessionEnd 同步 -> search 可检索”主链路。

6. `test_install_path_logic.py`  
   安装路径逻辑测试。验证全局安装与本地安装路径计算行为是否符合预期。

7. `test_config_entrypoints.py`  
   配置入口验证测试。覆盖 `init.py` 配置文件生成、`manage_memory.py config set/get`、以及当前已知遗漏点的回归断言。

8. `test_detail_jsonl.py`  
   JSONL 细节测试，覆盖 `read_jsonl/read_last_entry/read_recent_facts` 等行为。

9. `test_detail_sqlite.py`  
   SQLite 细节测试，覆盖 upsert、FTS、meta、sync_state、余弦相似度等核心能力。

10. `test_detail_chunk.py`  
    chunk 切分细节测试，覆盖短文本、空文本、长文本和标题分段行为。

11. `test_detail_load_and_hooks.py`  
    load/preCompact/stop 三类 Hook 脚本契约的细粒度断言。

12. `test_detail_sync_and_search.py`  
    sync 与 search 细节联测，覆盖增量同步、不重复、FTS/hybrid 查询与异常场景。

13. `test_detail_init.py`  
    init 细节测试，覆盖 hooks/rules/data/config 创建、幂等执行与 MEMORY.md 保留。

14. `test_detail_context_flow.py`  
    生命周期细节测试，覆盖 sessionStart/preCompact/stop/下一会话上下文延续。

15. `test_detail_regression.py`  
    回归细节测试，覆盖事实召回链路、衰减取样“取新不取旧”、`ts_id` 高频唯一性。

