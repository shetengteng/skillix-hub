# MEMORY.md 写入流程与规则

## 概述

`MEMORY.md` 是 Memory Skill 的**核心记忆文件**，存储用户偏好、项目背景、重要决策等长期有效的信息。它与自动提取的事实（daily/*.jsonl）和会话摘要（sessions.jsonl）共同构成完整的记忆体系。

文件位置：`<项目>/.cursor/skills/memory-data/MEMORY.md`

---

## 1. MEMORY.md 的生命周期

```
┌──────────────────────────────────────────────────────────────────┐
│                        MEMORY.md 生命周期                         │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ① 创建（init）                                                  │
│  └─ init/index.py → init_memory_dir() → 从模板复制               │
│                                                                  │
│  ② 读取（每次会话开始）                                            │
│  └─ sessionStart Hook → load_memory.py → 注入 Agent 上下文       │
│                                                                  │
│  ③ 写入（用户手动触发）                                            │
│  └─ 用户说"记住这个" → Agent 直接编辑 MEMORY.md                   │
│                                                                  │
│  ④ 索引同步（会话结束）                                            │
│  └─ sessionEnd Hook → sync_index.py → 切块写入 SQLite            │
│                                                                  │
│  ⑤ 导出（用户手动）                                               │
│  └─ manage export → 读取 MEMORY.md 内容包含在导出数据中            │
│                                                                  │
│  ⑥ 更新保护                                                      │
│  └─ update.py 不会修改 MEMORY.md                                  │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## 2. 创建时机

**触发**：首次安装时 `init/index.py` 调用 `init_memory_dir()`

**逻辑**（`helpers.py` 第 84-97 行）：
1. 检查 `MEMORY.md` 是否已存在
2. 如果不存在，优先从 `templates/MEMORY.md` 复制
3. 如果模板也不存在，创建默认内容

**模板内容**：

```markdown
# 核心记忆

## 用户偏好

## 项目背景

## 重要决策
```

**重要**：`update.py` 更新 Skill 时**不会修改** MEMORY.md，保证用户数据安全。

---

## 3. 读取时机

### 3.1 会话开始自动加载

**触发**：`sessionStart` Hook → `load_memory.py`

**流程**：
1. Hook 被 Cursor 在新会话开始时触发
2. `load_memory.py` 的 `load_context()` 读取 MEMORY.md 全文
3. 将内容格式化为 `## 核心记忆` 段落
4. 与近期事实、上次会话摘要合并
5. 通过 `additional_context` 注入 Agent 上下文

**输出格式**：

```
## 核心记忆

<MEMORY.md 全文内容>

## 近期事实

- [W][2026-02-20] 项目使用 PostgreSQL
- [O][2026-02-19] 用户偏好 TypeScript

## 上次会话

- 主题：API 重构
- 摘要：讨论了 RESTful API 的设计方案...
```

### 3.2 导出时读取

**触发**：用户执行 `manage export` 命令

**流程**：`cmd_export()` 读取 MEMORY.md 内容，包含在 `core_memory` 字段中导出。

### 3.3 统计时读取

**触发**：用户执行 `manage list --stats` 命令

**流程**：`cmd_list()` 读取 MEMORY.md 的文件大小和行数，包含在统计信息中。

---

## 4. 写入时机与规则

### 4.1 用户手动触发（唯一的写入方式）

**触发条件**：用户说"记住这个"、"把这个加到核心记忆"等

**执行者**：Agent（AI）

**方式**：Agent 直接编辑 `{{MEMORY_DATA_PATH}}/MEMORY.md` 文件

**SKILL.md 原文**：
> 用户说"记住这个" → 直接编辑 `{{MEMORY_DATA_PATH}}/MEMORY.md`，将信息添加到核心记忆中。

### 4.2 自动流程不写入 MEMORY.md

以下自动流程**不会**写入 MEMORY.md：

| Hook/脚本 | 写入目标 | 说明 |
|-----------|---------|------|
| `flush_memory.py`（preCompact） | `daily/YYYY-MM-DD.jsonl` | 通过 `save_fact.py` 写入 daily |
| `prompt_session_save.py`（stop） | `sessions.jsonl` + `daily/` | 通过 `save_summary.py` 和 `save_fact.py` |
| `sync_and_cleanup.py`（sessionEnd） | `index.sqlite` | 同步 JSONL → SQLite |
| `save_fact.py` | `daily/YYYY-MM-DD.jsonl` | 事实追加到当日文件 |
| `save_summary.py` | `sessions.jsonl` | 摘要追加到会话文件 |

---

## 5. MEMORY.md 与其他记忆数据的关系

```
┌─────────────────────────────────────────────────────────┐
│                    记忆数据体系                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  MEMORY.md（核心记忆）                                    │
│  ├─ 写入方式：Agent 手动编辑                              │
│  ├─ 内容：长期有效的偏好、背景、决策                        │
│  └─ 特点：人类可读，结构化 Markdown                       │
│                                                         │
│  daily/YYYY-MM-DD.jsonl（每日事实）                       │
│  ├─ 写入方式：save_fact.py 自动追加                       │
│  ├─ 内容：对话中提取的具体事实                             │
│  └─ 特点：自动提取，带类型/置信度/实体标签                  │
│                                                         │
│  sessions.jsonl（会话摘要）                               │
│  ├─ 写入方式：save_summary.py 自动追加                    │
│  ├─ 内容：每次会话的主题、摘要、决策、待办                  │
│  └─ 特点：自动生成，最后一条在下次会话加载                  │
│                                                         │
│  index.sqlite（搜索索引）                                 │
│  ├─ 写入方式：sync_index.py 自动同步                      │
│  ├─ 内容：上述所有数据的 FTS + 向量索引                    │
│  └─ 特点：只读镜像，支持全文和语义搜索                     │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 数据流向

```
用户说"记住" ──→ Agent 编辑 MEMORY.md
                      │
preCompact   ──→ save_fact.py ──→ daily/*.jsonl
                                       │
stop         ──→ save_summary.py ──→ sessions.jsonl
                                       │
sessionEnd   ──→ sync_index.py ──→ index.sqlite ←── MEMORY.md
                                                 ←── daily/*.jsonl
                                                 ←── sessions.jsonl
```

---

## 6. 索引同步

`sync_index.py` 中的 `sync_memory_md()` 负责将 MEMORY.md 同步到 SQLite：

1. 检查 MEMORY.md 的 mtime 是否变化
2. 如果变化，将内容按 Markdown 标题切块
3. 每个块作为 `chunk_type=core` 写入 SQLite
4. 生成 FTS 全文索引和可选向量嵌入
5. 更新 sync_state 记录

这使得 MEMORY.md 的内容可以通过 `search_memory.py` 进行语义搜索。

---

## 7. 总结

| 维度 | 说明 |
|------|------|
| 创建 | 安装时从模板复制，仅首次 |
| 读取 | 每次会话开始自动加载到 Agent 上下文 |
| 写入 | **仅用户手动触发**，Agent 直接编辑文件 |
| 自动写入 | 无。自动提取的事实写入 daily/*.jsonl，不写 MEMORY.md |
| 索引 | sessionEnd 时同步到 SQLite，支持搜索 |
| 更新保护 | update.py 不修改 MEMORY.md |
| 定位 | 长期核心记忆，与自动事实（短期/细粒度）互补 |
