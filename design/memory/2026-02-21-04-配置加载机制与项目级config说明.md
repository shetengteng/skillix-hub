# 配置加载机制与项目级 config.json 说明

## 核心问题

每次执行 memory 相关的 Python 脚本时，是否会读取各项目内部的 `config.json`？

**答案：是的。** 每个 hook 脚本和管理命令在执行时，都会通过 `Config` 类加载项目级 `config.json`，且项目级配置会覆盖全局配置。

---

## 配置加载架构

### 分层优先级（低 → 高）

```
1. 代码默认值 (_DEFAULTS)          ← defaults.py 中硬编码
2. 全局配置 (~/.memory/config.json) ← 所有项目共享
3. 项目级配置 (<project>/.cursor/skills/memory-data/config.json) ← 项目独立
4. 环境变量 (MEMORY_*)             ← 临时覆盖
```

高优先级的值会覆盖低优先级的同名字段。未设置的字段回退到更低优先级。

### 加载流程

```
Config.__init__(project_path)
  │
  ├─ 1. 加载 _DEFAULTS（代码默认值）
  │
  ├─ 2. 读取 ~/.memory/config.json
  │     └─ 深度合并到配置中（覆盖默认值）
  │
  ├─ 3. 读取 <project>/.cursor/skills/memory-data/config.json
  │     └─ 深度合并到配置中（覆盖全局配置）
  │
  ├─ 4. 读取 MEMORY_* 环境变量
  │     └─ 覆盖对应字段
  │
  └─ 5. 校验所有值（非法值回退到默认值）
```

---

## 哪些脚本会读取项目级 config.json

### Hook 脚本（自动触发）

| Hook 事件 | 脚本 | 读取配置的方式 |
|-----------|------|---------------|
| sessionStart | `load_memory.py` | `get_memory_dir()` → `get_config(project_path)` |
| preCompact | `flush_memory.py` | `get_memory_dir()` → `get_config(project_path)` |
| stop | `prompt_session_save.py` | `get_memory_dir()` → `get_config(project_path)` |
| postToolUse | `audit_tool_use.py` | `get_memory_dir()` → `get_config(project_path)` |
| afterAgentResponse | `audit_response.py` | `get_memory_dir()` → `get_config(project_path)` |
| afterAgentThought | `audit_thought.py` | `get_memory_dir()` → `get_config(project_path)` |
| sessionEnd | `sync_and_cleanup.py` | `get_memory_dir()` → `get_config(project_path)` |

### Agent 调用的脚本

| 脚本 | 读取配置的方式 |
|------|---------------|
| `save_fact.py` | `get_daily_dir()` → `get_memory_dir()` → `get_config(project_path)` |
| `save_summary.py` | `get_memory_dir()` → `get_config(project_path)` |
| `search_memory.py` | `get_config(project_path)` |

### 管理命令

| 命令 | 读取配置的方式 |
|------|---------------|
| `manage config show` | `get_config(project_path)` |
| `manage config set` | `get_config(project_path)` + 写入 |
| `manage list` | `get_config(project_path)` |
| `manage rebuild-index` | `get_config(project_path)` |
| `manage db *` | `get_config(project_path)` |

**结论：所有脚本在执行时都会读取当前项目的 `config.json`。**

---

## 项目级配置的实际效果

### 可独立配置的字段

| 字段 | 默认值 | 效果 |
|------|--------|------|
| `memory.load_days_full` | 2 | 完整加载最近 N 天的事实 |
| `memory.load_days_partial` | 5 | 部分加载 N 天内的事实 |
| `memory.load_days_max` | 7 | 最大加载天数 |
| `memory.partial_per_day` | 3 | 部分加载时每天取几条 |
| `memory.important_confidence` | 0.9 | 重要事实的置信度阈值 |
| `memory.facts_limit` | 15 | 加载事实的上限条数 |
| `embedding.model` | BAAI/bge-small-zh-v1.5 | 嵌入模型（变更需重建索引） |
| `index.chunk_tokens` | 400 | 分块大小（变更需重建索引） |
| `index.chunk_overlap` | 80 | 分块重叠（变更需重建索引） |
| `log.level` | INFO | 日志级别 |
| `log.retain_days` | 7 | 日志保留天数 |
| `cleanup.auto_cleanup_days` | 90 | 自动清理天数（0=禁用） |

### 示例：不同项目不同配置

**项目 A**（大型项目，需要更多上下文）：
```json
{
  "version": 1,
  "memory": {
    "load_days_full": 5,
    "facts_limit": 30
  }
}
```

**项目 B**（小项目，保持默认）：
```json
{
  "version": 1
}
```

**项目 C**（调试中，开启详细日志）：
```json
{
  "version": 1,
  "log": {
    "level": "DEBUG"
  }
}
```

---

## 配置文件缺失时的行为

| 文件 | 不存在时 | 影响 |
|------|---------|------|
| `~/.memory/config.json` | 跳过，使用默认值 | 无 |
| `<project>/.cursor/skills/memory-data/config.json` | 跳过，使用全局/默认值 | 功能正常，但无法做项目级定制 |

`Config` 类的 `_load_json_file` 在文件不存在时返回空字典，不会报错。所以 **`config.json` 缺失不会导致功能异常**，但会导致：
1. 无法通过 `manage config set` 持久化项目级配置
2. 所有配置回退到全局/默认值

---

## 调用链路图

```
用户在项目 A 中对话
  │
  ├─ sessionStart hook
  │   └─ load_memory.py
  │       ├─ init_hook_context(event) → 提取 project_path = "/path/to/project-A"
  │       ├─ get_memory_dir(project_path)
  │       │   └─ get_config(project_path)
  │       │       └─ Config("/path/to/project-A")
  │       │           ├─ 加载 _DEFAULTS
  │       │           ├─ 加载 ~/.memory/config.json（如果存在）
  │       │           ├─ 加载 /path/to/project-A/.cursor/skills/memory-data/config.json（如果存在）
  │       │           └─ 应用 MEMORY_* 环境变量
  │       └─ 使用配置值加载记忆
  │
  ├─ Agent 调用 save_fact.py --project-path /path/to/project-A
  │   └─ get_daily_dir(project_path)
  │       └─ get_memory_dir(project_path)
  │           └─ get_config(project_path)  ← 同样的加载链路
  │
  └─ sessionEnd hook
      └─ sync_and_cleanup.py
          └─ get_memory_dir(project_path)
              └─ get_config(project_path)  ← 同样的加载链路
```

---

## 已修复的问题

**问题**：全局安装后，新项目首次使用时 `memory-data` 目录缺少 `config.json`（和 `MEMORY.md`），只有运行时脚本创建的 `daily/`、`logs/` 等。

**原因**：
1. `config.json` 和 `MEMORY.md` 的创建逻辑只在 `init/index.py`（首次安装脚本）中
2. `load_memory.py` 的 `_ensure_memory_md()` 只创建 `MEMORY.md`，不创建 `config.json`
3. `sessionStart` hook 可能未成功执行（日志中无记录），导致 `_ensure_memory_md` 也未触发
4. 其他 hook（`audit_tool_use` 等）只创建自己需要的 `daily/` 子目录

**修复**：
1. 在 `service.config.__init__` 中新增 `ensure_memory_dir()` 公共函数，确保完整目录结构（`MEMORY.md` + `config.json` + `daily/`）
2. 在 `init_hook_context()` 中自动调用 `ensure_memory_dir()`，所有 hook 脚本在初始化时都会确保目录完整
3. `load_memory.py` 的 `load_context()` 中也调用 `ensure_memory_dir()` 作为双重保障
4. 使用 `_DIR_ENSURED` 集合缓存已检查的目录，避免同一进程内重复 IO
