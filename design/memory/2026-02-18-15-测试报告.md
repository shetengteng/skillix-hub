# Memory Skill 测试报告

> **日期**: 2026-02-18 23:45:06
> **Python**: 3.9.7
> **平台**: darwin
> **耗时**: 137.43s
> **结果**: ALL PASSED

---

## 汇总

| 指标 | 值 |
|------|----|
| 测试用例数 | 12 |
| 测试项总数 | 138 |
| 通过 | 138 |
| 失败 | 0 |
| 跳过 | 0 |
| 通过率 | 100.0% |

## 各测试用例结果

| # | 测试用例 | 通过 | 失败 | 跳过 | 状态 |
|---|----------|------|------|------|------|
| 1 | lib/config.py 配置模块 | 7 | 0 | 0 | PASS |
| 2 | lib/jsonl.py JSONL 读写 | 8 | 0 | 0 | PASS |
| 3 | lib/sqlite_store.py SQLite 操作 | 11 | 0 | 0 | PASS |
| 4 | Chunk 分割与重叠策略 | 9 | 0 | 0 | PASS |
| 5 | load_memory.py (sessionStart Hook) | 10 | 0 | 0 | PASS |
| 6 | flush_memory.py (preCompact Hook) | 10 | 0 | 0 | PASS |
| 7 | save_session.py (stop Hook) | 10 | 0 | 0 | PASS |
| 8 | sync_index.py (JSONL → SQLite 同步) | 11 | 0 | 0 | PASS |
| 9 | search_memory.py (Agent 搜索工具) | 13 | 0 | 0 | PASS |
| 10 | init.py (一键初始化) | 10 | 0 | 0 | PASS |
| 11 | 上下文完整性与端到端验证 | 10 | 0 | 0 | PASS |
| 12 | 端到端完整场景验证 | 29 | 0 | 0 | PASS |

## 详细测试项

### 1. lib/config.py 配置模块

| 测试项 | 状态 | 详情 |
|--------|------|------|
| get_project_path 提取 workspace_roots | ✓ | - |
| get_project_path 无 roots 时回退 cwd | ✓ | - |
| get_memory_dir 返回正确路径 | ✓ | - |
| get_daily_dir 包含 daily | ✓ | - |
| CHUNK_TOKENS = 400 | ✓ | - |
| CHUNK_OVERLAP = 80 | ✓ | - |
| DEFAULT_EMBEDDING_MODEL 已设置 | ✓ | - |

### 2. lib/jsonl.py JSONL 读写

| 测试项 | 状态 | 详情 |
|--------|------|------|
| read_jsonl 返回列表 | ✓ | - |
| read_jsonl 读取 2 条记录 | ✓ | got 2 |
| read_last_entry 返回字典 | ✓ | - |
| read_last_entry 包含 id 字段 | ✓ | - |
| read_recent_facts 返回列表 | ✓ | - |
| read_recent_facts 非空 | ✓ | count=2 |
| read_jsonl 不存在文件返回 [] | ✓ | - |
| read_last_entry 不存在文件返回 None | ✓ | - |

### 3. lib/sqlite_store.py SQLite 操作

| 测试项 | 状态 | 详情 |
|--------|------|------|
| 数据库正常打开 | ✓ | - |
| INSERT 写入成功 | ✓ | count=1 |
| UPSERT 不产生重复 | ✓ | count=1 |
| FTS5 搜索返回结果 | ✓ | count=1 |
| FTS5 搜索无匹配返回空 | ✓ | - |
| meta get/set 正常 | ✓ | got test_value |
| schema_version 已初始化 | ✓ | - |
| 余弦相似度（相同向量）= 1.0 | ✓ | - |
| 余弦相似度（正交向量）= 0.0 | ✓ | - |
| 余弦相似度（反向向量）= -1.0 | ✓ | - |
| sync_state 读写正常 | ✓ | - |

### 4. Chunk 分割与重叠策略

| 测试项 | 状态 | 详情 |
|--------|------|------|
| 短文本保持为 1 个 chunk | ✓ | - |
| 长文本分割为多个 chunks | ✓ | got 4 |
| Chunk 0 非空 | ✓ | - |
| Chunk 1 非空 | ✓ | - |
| Chunk 2 非空 | ✓ | - |
| Chunk 3 非空 | ✓ | - |
| 空文本返回 0 个 chunks | ✓ | - |
| 按 Markdown 标题分段 | ✓ | got 3 |
| 第 2 段以 ## 开头 | ✓ | - |

### 5. load_memory.py (sessionStart Hook)

| 测试项 | 状态 | 详情 |
|--------|------|------|
| Exit code = 0 | ✓ | got 0 |
| 输出为有效 JSON | ✓ | - |
| 包含 additional_context | ✓ | - |
| 加载了 MEMORY.md（核心记忆） | ✓ | - |
| 加载了 facts（近期事实） | ✓ | - |
| 加载了 sessions（上次会话） | ✓ | - |
| MEMORY.md 内容包含用户偏好 | ✓ | - |
| MEMORY.md 内容包含项目背景 | ✓ | - |
| 记录了 session_start 事件 | ✓ | - |
| 空输入不崩溃（exit 0） | ✓ | - |

### 6. flush_memory.py (preCompact Hook)

| 测试项 | 状态 | 详情 |
|--------|------|------|
| Exit code = 0 | ✓ | - |
| 输出为有效 JSON | ✓ | - |
| 包含 user_message | ✓ | - |
| 以 [Memory Flush] 开头 | ✓ | - |
| 包含上下文使用率 85% | ✓ | - |
| 包含消息数 30 | ✓ | - |
| 包含写入指令（save_fact.py） | ✓ | - |
| 包含保存工具路径 | ✓ | - |
| 包含 memory_type 分类说明 | ✓ | - |
| 不同参数（50%/10）正确替换 | ✓ | - |

### 7. save_session.py (stop Hook)

| 测试项 | 状态 | 详情 |
|--------|------|------|
| completed: Exit code = 0 | ✓ | - |
| completed: 输出为有效 JSON | ✓ | - |
| completed: 包含 followup_message | ✓ | - |
| completed: 以 [Session Save] 开头 | ✓ | - |
| completed: 包含摘要指令 | ✓ | - |
| completed: 包含保存工具（save_summary.py） | ✓ | - |
| interrupted: Exit code = 0 | ✓ | - |
| interrupted: 输出为空 JSON {} | ✓ | - |
| cancelled: 输出为空 JSON {} | ✓ | - |
| 空输入不崩溃（exit 0） | ✓ | - |

### 8. sync_index.py (JSONL → SQLite 同步)

| 测试项 | 状态 | 详情 |
|--------|------|------|
| Exit code = 0 | ✓ | - |
| index.sqlite 已创建 | ✓ | - |
| 同步了数据（chunks > 0） | ✓ | count=7 |
| FTS 搜索 PostgreSQL 有结果 | ✓ | count=2 |
| FTS 搜索 daily 数据有结果 | ✓ | count=1 |
| meta.last_sync 已更新 | ✓ | - |
| meta.total_chunks 已更新 | ✓ | val=7 |
| 增量同步 exit = 0 | ✓ | - |
| 增量同步不产生重复 | ✓ | before=7, after=7 |
| --rebuild exit = 0 | ✓ | - |
| rebuild 后数据一致 | ✓ | original=7, rebuilt=7 |

### 9. search_memory.py (Agent 搜索工具)

| 测试项 | 状态 | 详情 |
|--------|------|------|
| FTS: 输出为有效 JSON | ✓ | - |
| FTS: 包含 results 数组 | ✓ | - |
| FTS: 包含 method 字段 | ✓ | - |
| FTS: 包含 total 字段 | ✓ | - |
| FTS: 搜索 PostgreSQL 有结果 | ✓ | total=2 |
| hybrid: 输出有效 | ✓ | - |
| --max-results=1 限制有效 | ✓ | - |
| 无结果查询: total=0 | ✓ | - |
| 无结果查询: exit code=1 | ✓ | - |
| vector: 搜索有结果 | ✓ | total=7 |
| vector: method=vector 或降级 fts | ✓ | - |
| hybrid+embedding: 搜索有结果 | ✓ | total=7 |
| 无索引: exit code=2 | ✓ | - |

### 10. init.py (一键初始化)

| 测试项 | 状态 | 详情 |
|--------|------|------|
| Exit code = 0 | ✓ | - |
| hooks.json 已创建 | ✓ | - |
| hooks.json 格式正确（有效 JSON） | ✓ | - |
| hooks.json 包含全部 3 个 Hook | ✓ | - |
| memory-rules.mdc 已创建 | ✓ | - |
| memory-data/ 已创建 | ✓ | - |
| memory-data/daily/ 已创建 | ✓ | - |
| MEMORY.md 已创建 | ✓ | - |
| 幂等运行 exit = 0 | ✓ | - |
| MEMORY.md 不被覆盖（保留自定义内容） | ✓ | - |

### 11. 上下文完整性与端到端验证

| 测试项 | 状态 | 详情 |
|--------|------|------|
| E2E sessionStart: 返回上下文 | ✓ | - |
| E2E preCompact: 生成 flush 指令 | ✓ | - |
| E2E: 模拟 Agent 写入 fact | ✓ | - |
| E2E stop: 生成 save 指令 | ✓ | - |
| E2E: 模拟 Agent 写入 session summary | ✓ | - |
| E2E 新会话: 包含核心记忆 | ✓ | - |
| E2E 新会话: 加载了 Redis 相关事实 | ✓ | - |
| E2E 新会话: 加载了最新会话（缓存方案） | ✓ | - |
| E2E sync: exit = 0 | ✓ | - |
| E2E search Redis: 有结果 | ✓ | total=2 |

### 12. 端到端完整场景验证

| 测试项 | 状态 | 详情 |
|--------|------|------|
| 会话1 sessionStart: 返回核心记忆 | ✓ | - |
| 会话1 sessionStart: 包含用户偏好 | ✓ | - |
| 会话1: daily.jsonl 已创建 | ✓ | - |
| 会话1 preCompact: [Memory Flush] 指令生成 | ✓ | - |
| 会话1: Agent 写入 3 条 facts | ✓ | - |
| 会话1 stop: [Session Save] 指令生成 | ✓ | - |
| 会话1: Agent 写入 session summary | ✓ | - |
| sync_index: exit = 0 | ✓ | - |
| SQLite 文件已创建 | ✓ | - |
| SQLite 文件大小 > 0 | ✓ | size=90112 bytes |
| SQLite chunks 总数 | ✓ | count=11 |
| SQLite schema_version = 1 | ✓ | - |
| SQLite last_sync 已记录 | ✓ | - |
| FTS5 搜索 Redis | ✓ | results=2 |
| FTS5 搜索 TypeScript | ✓ | results=2 |
| 会话2: 包含核心记忆 | ✓ | - |
| 会话2: 加载了 Redis 事实 | ✓ | - |
| 会话2: 加载了 TypeScript 事实 | ✓ | - |
| 会话2: 加载了上次会话摘要 | ✓ | - |
| 会话2: 包含决策信息 | ✓ | - |
| 搜索 'Redis': 有结果 | ✓ | total=2 |
| 搜索 'TypeScript': 有结果 | ✓ | total=2 |
| 向量搜索 '缓存技术方案': 有结果 | ✓ | total=10 |
| 混合搜索 'Redis' (FTS+向量): 有结果 | ✓ | total=10 |
| SQLite 记录了嵌入模型名称 | ✓ | - |
| daily.jsonl 行数正确 | ✓ | lines=6 (1 original + 2 session_start + 3 facts) |
| sessions.jsonl 行数正确 | ✓ | lines=2 (1 original + 1 new) |
| daily.jsonl 每行都是有效 JSON | ✓ | - |
| sessions.jsonl 每行都是有效 JSON | ✓ | - |
