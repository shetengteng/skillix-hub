# 日志系统设计

## 目标

为 Memory Skill 提供可观测性，让用户清楚知道：

- 本地嵌入模型是否被调用
- 每次操作的耗时和结果
- 错误发生的位置和原因

## 设计方案

### 日志存储

```
skills/memory/logs/
├── 2026-02-18.log
├── 2026-02-19.log
└── ...（按天自动轮转）
```

每天一个日志文件，文件名为日期，纯文本格式。

### 日志格式

```
[2026-02-18 14:30:05] [INFO] [embedding] 加载本地模型 BAAI/bge-small-zh-v1.5 从 ~/.memory/models/
[2026-02-18 14:30:07] [INFO] [embedding] 模型加载完成 (耗时 2.1s)
[2026-02-18 14:30:07] [INFO] [embedding] 生成向量 dim=512, 文本长度=156 (耗时 0.03s)
[2026-02-18 14:30:08] [INFO] [sync] 同步完成: 新增 5 条 chunk, 跳过 3 条
[2026-02-18 14:30:08] [WARN] [search] 嵌入模型未加载，回退到 FTS 搜索
[2026-02-18 14:30:09] [ERROR] [sqlite] 写入失败: disk full
```

格式：`[时间戳] [级别] [模块] 消息`

### 级别定义

| 级别 | 说明 | 使用场景 |
|------|------|----------|
| DEBUG | 详细调试 | 向量维度、SQL 查询、JSON 行数 |
| INFO | 正常操作 | 模型加载、同步完成、搜索执行 |
| WARN | 需注意 | 模型缺失回退、文件为空 |
| ERROR | 操作失败 | 模型加载失败、写入失败 |

默认级别：**INFO**，可通过环境变量 `MEMORY_LOG_LEVEL` 调整。

### 需要记录日志的模块

| 模块 | 关键日志点 |
|------|-----------|
| `embedding.py` | 模型路径、加载耗时、向量生成耗时、维度 |
| `sync_index.py` | 同步开始/完成、新增/跳过数量、嵌入生成进度 |
| `search_memory.py` | 搜索模式(fts/vector/hybrid)、结果数量、耗时 |
| `load_memory.py` | 加载的事实数/会话数、MEMORY.md 大小 |
| `save_fact.py` | 保存成功的 fact id |
| `save_summary.py` | 保存成功的 summary id |
| `init.py` | 模型下载进度、配置文件安装结果 |

### 实现方式

在 `lib/logger.py` 中提供统一的日志模块：

```python
import logging
from lib.config import get_log_dir

def get_logger(name: str) -> logging.Logger:
    # 按天创建日志文件
    # 格式: [时间] [级别] [模块名] 消息
    # 同时输出到 stderr（不干扰 stdout 的 JSON 输出）
```

关键设计点：

1. **日志写 stderr + 文件，stdout 保留给 JSON 输出** — Hook 脚本通过 stdout 返回 JSON 给 Cursor，日志不能污染 stdout
2. **按天自动轮转** — 基于日期自动创建新文件，无需清理配置
3. **自动清理** — 保留最近 7 天的日志（可配置）
4. **线程安全** — 使用 Python logging 内置锁机制

### 配置项（config.py 新增）

```python
LOG_DIR_NAME = "logs"
LOG_RETAIN_DAYS = 7
LOG_LEVEL = os.environ.get("MEMORY_LOG_LEVEL", "INFO")
```

### 使用示例

```python
from lib.logger import get_logger

log = get_logger("embedding")

log.info("加载模型 %s 从 %s", model_name, model_path)
log.info("模型加载完成 (耗时 %.1fs)", elapsed)
log.warning("嵌入模型未找到，回退到 FTS")
log.error("向量生成失败: %s", str(e))
```

### 日志目录位置

- **开发/安装目录**：`skills/memory/logs/`（源代码中）
- **运行时目录**：`.cursor/skills/memory/logs/`（安装后的运行时日志）
- 日志目录不跟随 `memory-data`，因为日志属于 Skill 自身而非记忆数据
