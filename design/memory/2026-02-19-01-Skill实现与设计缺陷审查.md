# Skill 实现与设计缺陷审查

> 日期：2026-02-19  
> 审查对象：`skills/memory`（源码）、`.cursor/skills/memory`（安装副本）、`设计/` 系列文档  
> 审查方式：静态代码审查 + 全量测试执行 + 最小复现实验

---

## 1. 审查结论（先看结论）

当前实现整体可运行（全量测试 138/138 通过），但存在多处**高优先级功能缺陷**与**设计-实现偏差**，会直接影响记忆系统的可用性和性能：

1. **记忆写入链路与加载链路断裂**：`save_fact.py` 写入 `daily/*.jsonl`，`load_memory.py` 却只读 `facts.jsonl`，且 `sessionStart` 未自动同步索引，导致新事实难以被自动召回。
2. **嵌入模型缓存逻辑失效**：代码期望命中本地缓存，但实际路径判断与 HuggingFace 缓存目录结构不一致，跨进程反复“未命中 + 下载/加载”，导致每次查询都有明显冷启动开销。
3. **事实衰减加载策略实现偏差**：中间时间窗按“每天最多 N 条”时，当前实现选的是**较早**记录而非较新记录，违背“近多远少”的时间优先意图。
4. **ID 生成粒度过粗**：`ts_id()` 仅精确到秒，短时间多次写入可生成重复 ID，后续同步到 SQLite 时会 `upsert` 覆盖，存在数据丢失风险。
5. **设计文档与实现明显脱节**：路径、数据流、写入方式、同步时机等核心描述存在多处过时信息，影响后续维护和协作。

---

## 2. 高优先级缺陷（P0/P1）

## 2.1 P0：事实“写了但默认读不回来”（链路断裂）

### 现象
- `save_fact.py` 将事实写入 `daily/YYYY-MM-DD.jsonl`
- `load_memory.py` 读取的是 `facts.jsonl`（不是 `daily`）
- 当前代码中没有“daily -> facts.jsonl 去重汇总”实现
- `load_memory.py` 也没有调用 `sync_index.py` 自动同步

### 证据
- `lib/config.py` 注释：`facts.jsonl`“暂未使用，预留”
- `scripts/load_memory.py`：只读 `facts.jsonl` + `sessions.jsonl`
- `scripts/save_fact.py`：只写 `daily/*.jsonl`
- `scripts/sync_index.py`：可同步 daily 到 SQLite，但未在 `load_memory.py` 自动触发

### 复现（已执行）
1. `init.py --skip-model`
2. `save_fact.py` 写入唯一 token（仅在 daily）
3. `load_memory.py` 执行 sessionStart
4. 返回上下文中“近期事实 0 条”，未包含该 token

### 影响
- 用户期望“记住”的内容在下个会话开始时大概率无法自动出现
- 记忆系统核心价值（跨会话 recall）被削弱

### 建议
- 二选一（建议 A）：
  - **A.** `load_memory.py` 改为直接从 `daily/*.jsonl` 按衰减策略读取事实（去掉对 `facts.jsonl` 的硬依赖）
  - **B.** 实现并启用 daily -> facts 的汇总任务，保证 facts 真正成为可加载来源
- 并在 `sessionStart` 明确同步策略（自动同步或明确不自动同步+文档说明）

---

## 2.2 P0：嵌入缓存命中失败，重复冷启动

### 现象
- 日志频繁出现：`本地缓存未命中，从远程下载 ...`
- 即使前一次已加载，下一次新进程仍显示“未命中”

### 根因
- `embedding.py` 使用 `local_path = ~/.memory/models/BAAI--bge-small-zh-v1.5`
- 实际缓存目录是 HuggingFace 风格：`models--BAAI--bge-small-zh-v1.5/...`
- 路径判定不匹配，导致 `os.path.isdir(local_path)` 长期为 false

### 证据
- 缓存目录实际内容：`models--BAAI--bge-small-zh-v1.5/...`
- 两次独立进程连续调用 `is_available()`，均打印“本地缓存未命中”

### 影响
- 每次查询/同步都承担 6~10 秒冷启动
- 离线或弱网环境稳定性差
- 与“全局缓存避免重复下载”的设计目标冲突

### 建议
- 统一采用与 sentence-transformers/HF 一致的缓存判定：
  - 直接 `SentenceTransformer(model_name, cache_folder=GLOBAL_MODEL_CACHE)`，不手工拼自定义 `local_path`
  - 或使用 `snapshot_download` 返回实际目录后再加载
- 另建议把“下载”与“加载”日志语义分开，避免误导

---

## 2.3 P1：衰减加载选错样本（取旧不取新）

### 现象
- `read_recent_facts()` 对 partial 区间每天取 `day_entries[:N]`
- 文件是追加写入，`[:N]` 实际取到的是该日较早事实

### 复现（已执行）
- 构造同一天 5 条事实（按时间递增），结果选中 `fact-1/2/3` 而非 `fact-3/4/5`

### 影响
- “近多远少”策略被稀释，召回不够新
- 会话连续性下降，尤其在高频事实写入场景

### 建议
- partial 桶改为取当天最新 N 条（如 `day_entries[-N:]`，并确保按时间排序）

---

## 2.4 P1：ID 秒级冲突风险

### 现象
- `utils.ts_id()` 仅到秒（`%H%M%S`）
- 同秒内多次写入会重复 ID

### 证据
- 同进程连续调用 `ts_id()`，返回完全相同值

### 影响
- JSONL 中可能出现重复 `id`
- 同步到 SQLite 时 `id` 主键冲突，`INSERT OR REPLACE` 造成覆盖

### 建议
- ID 至少加毫秒/随机后缀（如 `HHMMSSmmm` + 短随机串）
- 或统一使用 `uuid4` / 单调计数器

---

## 3. 中优先级问题（P2）

## 3.1 全局安装路径相对化风险（`init.py --global`）

### 问题点
- `--global` 模式仍使用 `os.path.relpath(skill_install_dir, project_path)` 生成 hooks 命令路径
- 全局 hooks 面向不同项目时，基于某个项目算出的相对路径可能不通用

### 建议
- `--global` 模式下直接写绝对路径（`~/.cursor/...` 或展开后的绝对路径）

---

## 3.2 测试存在“假阳性”断言

### 问题点
- `test_e2e.py` 有断言：`emb_model is not None or True`（恒为 True）

### 影响
- 测试报告“通过”不能证明该能力真实可用

### 建议
- 改为严格断言并给出失败提示（例如检查 `meta.embedding_model` 真实值）

---

## 4. 设计文档缺陷（实现已变更但文档未同步）

以下是影响较大的不一致：

1. **路径体系过时**：大量文档仍写 `.memory-data`，实现已是 `.cursor/skills/memory-data`
2. **写入方式过时**：文档大量示例 `echo >>`，实现已改为 `save_fact.py/save_summary.py`
3. **数据流描述不实**：文档强调 sessionStart 自动 sync + facts 汇总，代码未实现对应流程
4. **事件模型不一致**：文档提及 `session_end` 写入 daily，代码未落地

### 影响
- 新成员按文档操作会得到与代码不一致的结果
- 后续缺陷定位成本上升

### 建议
- 以源码行为为准，统一修订 01/03/04/05/06/07/08/12 等核心文档
- 在文档中明确“已实现 / 未实现 / 计划中”状态，避免把目标态写成现状

---

## 5. 测试现状评估

### 已验证
- Hook 脚本结构与输入输出基本可用
- 同步/搜索主流程在当前测试数据下可运行

### 未充分覆盖（建议补）
- save_fact 写入后，sessionStart 是否能直接召回（当前会失败）
- 嵌入缓存是否跨进程命中
- partial 天内事实选择是否偏向最新
- 高频写入 ID 唯一性
- 全局安装路径可用性（跨项目）

---

## 6. 建议修复优先级

### 第一批（立即）
1. 修复事实召回主链路（daily/facts/sync 三者打通）
2. 修复 embedding 缓存路径判定
3. 修复 partial 选样逻辑

### 第二批（本周）
4. 修复 ID 唯一性策略
5. 修正 `--global` 路径策略
6. 修复测试假阳性断言并补关键回归用例

### 第三批（并行）
7. 统一更新设计文档与当前实现状态

---

## 7. 总结

当前版本“能跑通测试”，但距离“稳定可持续的生产级记忆系统”仍有关键差距，核心在于：

- **主链路要闭环**（写入 -> 同步/索引 -> 加载/召回）
- **缓存要真实生效**（避免每次冷启动）
- **文档要反映现状**（降低维护风险）

建议按上述优先级先修 P0/P1，再统一补齐文档与测试。

