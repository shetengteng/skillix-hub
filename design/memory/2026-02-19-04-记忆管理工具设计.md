# 记忆管理工具设计

> 日期：2026-02-19  
> 核心理念：用户通过自然语言与 Cursor Agent 交互进行记忆的增删改查，Agent 作为中间层调用 CLI 工具

---

## 1. 交互模型

### 用户不直接操作工具

```
用户 ←→ Cursor Agent ←→ manage_memory.py ←→ JSONL / SQLite
      自然语言         CLI（JSON I/O）       文件读写
```

用户说的是自然语言（"删掉 Redis 相关的记忆"），Agent 负责：
1. 理解用户意图
2. 选择合适的子命令和参数
3. 调用 CLI 工具并解析 JSON 输出
4. 将结果转述给用户
5. 需要确认时询问用户

### 典型交互流程

```
用户: "删掉关于 Redis 的记忆"
    ↓
Agent: 调用 manage_memory.py list --keyword "Redis"
Agent: 解析 JSON 输出（5 条记录）
Agent: "找到 5 条关于 Redis 的记忆：
        1. [W] Redis 缓存方案选型
        2. [W] 决定使用 Redis Cluster
        ... 确认删除吗？"
    ↓
用户: "确认"
    ↓
Agent: 调用 manage_memory.py delete --keyword "Redis" --confirm
Agent: "已删除 5 条记录，搜索索引已同步。"
```

### 职责分离

- **数据操作**（list/delete/edit/...）：`manage_memory.py` 各子命令
- **系统配置**（调参/改模型）：`manage_memory.py config ...`（独立子命令组）
- Agent 根据用户意图自动路由到对应模块，用户不感知区别

---

## 2. 设计方案

### 统一入口：`manage_memory.py`

```bash
python3 manage_memory.py <子命令> [参数]
```

**所有输出统一为 JSON**（Agent 解析友好）。错误输出到 stderr（供日志），正常结果输出到 stdout（供 Agent 解析）。

### 子命令总览

| 子命令 | 用户怎么说 | Agent 怎么调 |
|--------|-----------|-------------|
| `list` | "看看最近记了什么" | `list --days 3` |
| `stats` | "记忆系统什么状态" | `stats` |
| `delete` | "删掉关于 X 的记忆" | `list` 预览 → 确认 → `delete --confirm` |
| `restore` | "恢复刚才删的" | `restore --id xxx` 或 `--from-backup` |
| `edit` | "把那条记录改一下" | `list --id` 查看 → `edit` |
| `export` | "备份所有记忆" | `export --output path` |
| `import` | "恢复上次备份" | `import --input path` |
| `cleanup` | "清理旧记忆" | `list` 预览 → 确认 → `cleanup --confirm` |
| `rebuild-index` | "搜索好像不对" | `rebuild-index` |
| `doctor` | "记忆系统有问题吗" | `doctor` |
| `config` | "看看/改改配置" | `config show/set/get/...` |

### 全局参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--project-path` | 项目根目录路径 | 当前目录 |

---

## 3. JSON 输出协议

所有子命令的 stdout 输出统一格式：

### 成功响应

```json
{
  "status": "ok",
  "command": "list",
  "data": { ... }
}
```

### 预览响应（dry-run）

```json
{
  "status": "preview",
  "command": "delete",
  "data": {
    "total": 5,
    "records": [ ... ],
    "affected_files": ["daily/2026-02-15.jsonl"],
    "message": "将软删除 5 条记录"
  }
}
```

### 错误响应

```json
{
  "status": "error",
  "command": "delete",
  "error": {
    "code": "LOCK_BUSY",
    "message": "另一个操作正在进行，请稍后重试"
  }
}
```

### Exit Code 约定

| 退出码 | 含义 |
|--------|------|
| 0 | 成功 |
| 1 | 无匹配结果 |
| 2 | 参数错误 |
| 3 | 文件锁冲突 |
| 4 | 其他错误 |

---

## 4. 子命令详细设计

### 4.1 `list` — 查询记录

Agent 最常用的子命令。先查后删/改的第一步。

**默认作用范围**：`--scope all`（list 场景下用户通常想看全部）。

```bash
# 按时间
manage_memory.py list --days 3

# 按关键字
manage_memory.py list --keyword "Redis"

# 按日期范围
manage_memory.py list --from 2026-02-15 --to 2026-02-18

# 按类型
manage_memory.py list --type fact

# 按 ID
manage_memory.py list --id "log-040511053-dxgf"

# 分页（首次查询返回 snapshot token，后续翻页基于同一视图）
manage_memory.py list --limit 20 --offset 0
manage_memory.py list --limit 20 --offset 20 --snapshot <token>

# 限定范围
manage_memory.py list --scope daily --days 7
```

**输出**：
```json
{
  "status": "ok",
  "command": "list",
  "data": {
    "total": 3,
    "offset": 0,
    "limit": 50,
    "snapshot": "abc123",
    "records": [
      {
        "id": "log-040511053-dxgf",
        "type": "fact",
        "memory_type": "W",
        "content": "Memory Skill 现有 4 个 Hook",
        "entities": ["Hook", "sessionEnd"],
        "confidence": 0.8,
        "timestamp": "2026-02-19T12:05:11Z",
        "source_file": "daily/2026-02-19.jsonl",
        "deleted_at": null
      }
    ]
  }
}
```

Agent 拿到 JSON 后，转述给用户：
> 找到 3 条记忆：
> 1. [W] Memory Skill 现有 4 个 Hook（2/19）
> 2. [W] 缺陷审查 7 项全部修复（2/19）
> 3. [W] 嵌入模型缓存路径...（2/19）

### 4.2 `stats` — 统计概览

```bash
manage_memory.py stats
```

**输出**：
```json
{
  "status": "ok",
  "command": "stats",
  "data": {
    "disk_usage_kb": 156,
    "daily": {
      "file_count": 5,
      "date_range": ["2026-02-15", "2026-02-19"],
      "facts": 23,
      "system_events": 12,
      "deleted": 2,
      "total": 37
    },
    "sessions": {
      "count": 8,
      "latest_topic": "记忆管理工具设计"
    },
    "memory_md": {
      "size_kb": 1.2,
      "lines": 25
    },
    "index": {
      "size_kb": 90,
      "chunks": 42,
      "last_sync": "2026-02-19T12:01:12Z",
      "embedding_model": "BAAI/bge-small-zh-v1.5"
    },
    "model_cache": {
      "path": "~/.memory-skill/models/",
      "models": ["BAAI/bge-small-zh-v1.5"]
    }
  }
}
```

Agent 转述：
> 记忆系统状态：共 35 条事实（5 天）、8 条会话摘要，占用 156KB。索引 42 块，最后同步 2/19 12:01。

### 4.3 `delete` — 删除记录

**默认软删除**：标记 `deleted_at` 和 `deleted_by`，记录不真正移除，搜索时自动过滤。

**作用范围默认**：`--scope daily`（避免误删会话摘要）。

```bash
# 步骤 1：预览（Agent 自动先调这个）
manage_memory.py delete --keyword "Redis"

# 步骤 2：确认执行（软删除）
manage_memory.py delete --keyword "Redis" --confirm

# 物理删除（不可恢复，需更高确认级别）
manage_memory.py delete --keyword "Redis" --purge --confirm
```

**预览输出（无 --confirm）**：
```json
{
  "status": "preview",
  "command": "delete",
  "data": {
    "total": 5,
    "mode": "soft",
    "records": [ ... ],
    "affected_files": ["daily/2026-02-15.jsonl"],
    "message": "将软删除 5 条记录（可通过 restore 恢复）"
  }
}
```

**执行输出（有 --confirm）**：
```json
{
  "status": "ok",
  "command": "delete",
  "data": {
    "deleted": 5,
    "mode": "soft",
    "affected_files": ["daily/2026-02-15.jsonl"],
    "backup_path": "backups/2026-02-19-120500/",
    "index_synced": true
  }
}
```

**删除条件参数**：

| 参数 | 说明 |
|------|------|
| `--keyword` | 内容包含关键字 |
| `--id` | 精确匹配 ID |
| `--type` | 按类型（fact/session_start/session_end） |
| `--before` | 早于某日期 |
| `--from/--to` | 日期范围 |
| `--scope` | `daily`（默认）/`sessions`/`all` |
| `--all` | 删除全部 |
| `--purge` | 物理删除（不可恢复） |

**软删除实现**：在 JSONL 条目中添加 `deleted_at` 字段。`load_memory.py` 和 `search_memory.py` 过滤 `deleted_at != null` 的条目。

### 4.4 `restore` — 恢复记录

```bash
# 恢复软删除的单条记录
manage_memory.py restore --id "log-040511053-dxgf"

# 恢复指定时间范围内所有软删除的记录
manage_memory.py restore --from 2026-02-19

# 从自动备份恢复（物理删除/损坏场景）
manage_memory.py restore --from-backup 2026-02-19-120500
```

**输出**：
```json
{
  "status": "ok",
  "command": "restore",
  "data": {
    "restored": 5,
    "mode": "soft-undelete",
    "index_synced": true
  }
}
```

### 4.5 `edit` — 修改条目

```bash
manage_memory.py edit --id "log-xxx" --content "新内容"
manage_memory.py edit --id "log-xxx" --memory-type B --confidence 0.95
```

**可修改字段白名单**：`content`、`memory_type`（W/B/O）、`confidence`（0~1）、`entities`

**输出**：
```json
{
  "status": "ok",
  "command": "edit",
  "data": {
    "id": "log-xxx",
    "updated_fields": ["content"],
    "index_synced": true
  }
}
```

### 4.6 `export` / `import`

```bash
# 导出
manage_memory.py export --output backup.json
manage_memory.py export --scope all --output backup.json

# 导入（合并，不覆盖已有 ID）
manage_memory.py import --input backup.json --mode merge
# 导入（替换，需确认）
manage_memory.py import --input backup.json --mode replace --confirm
```

### 4.7 `cleanup` — 批量清理

**作用范围默认**：`--scope daily`。

```bash
manage_memory.py cleanup --older-than 30           # 预览
manage_memory.py cleanup --older-than 30 --confirm  # 执行（软删除）
manage_memory.py cleanup --system-events --confirm   # 清理系统事件
manage_memory.py cleanup --purge-deleted --confirm   # 物理清除已软删除的记录
```

### 4.8 `rebuild-index`

```bash
manage_memory.py rebuild-index           # 增量
manage_memory.py rebuild-index --full    # 全量重建
```

索引同步模式：

| 参数 | 说明 | 适用场景 |
|------|------|----------|
| `--sync-mode immediate` | 立即同步（默认） | 小批量操作 |
| `--sync-mode deferred` | 返回成功后异步重建 | 大批量清理 |
| `--sync-timeout 30` | 同步超时秒数 | 数据量大时调大 |

### 4.9 `doctor` — 健康检查

```bash
manage_memory.py doctor
```

**输出**：
```json
{
  "status": "ok",
  "command": "doctor",
  "data": {
    "checks": [
      {"name": "JSONL 可解析性", "status": "pass", "detail": "35 条全部有效"},
      {"name": "ID 唯一性", "status": "pass", "detail": "43 个 ID 无重复"},
      {"name": "SQLite 可访问", "status": "pass", "detail": "42 个 chunks"},
      {"name": "索引时效性", "status": "warn", "detail": "last_sync 落后 JSONL 4 分钟"},
      {"name": "模型缓存", "status": "pass", "detail": "BAAI/bge-small-zh-v1.5 存在"},
      {"name": "数据一致性", "status": "pass", "detail": "JSONL 35条 vs SQLite 42 chunks"},
      {"name": "单日写入异常", "status": "pass", "detail": "最大单日 12 条，无异常"},
      {"name": "重复ID率", "status": "pass", "detail": "0%"},
      {"name": "日志错误率", "status": "pass", "detail": "0 errors in 7 days"}
    ],
    "summary": {"pass": 8, "warn": 1, "fail": 0},
    "thresholds": {
      "index_lag_warn_minutes": 10,
      "daily_write_spike": 100,
      "duplicate_id_warn_pct": 1
    }
  }
}
```

**阈值告警**：

| 告警项 | 阈值 | 说明 |
|--------|------|------|
| 索引滞后 | >10 分钟 | warn |
| 单日写入暴涨 | >100 条 | warn（可能异常写入） |
| 重复 ID 比例 | >1% | warn |
| 日志错误率 | >5 errors/day | warn |

Agent 转述：
> 检查完成：8 项通过，1 项警告（索引滞后 4 分钟，建议运行一次索引同步）。

---

## 5. 操作风险分级

所有操作按风险等级分类，控制确认强度：

| 等级 | 操作 | 确认策略 |
|------|------|----------|
| L1（安全） | list / stats / export / doctor / config show | 无需确认 |
| L2（低风险） | edit / delete 单条（--id） / config set | 一次确认 |
| L3（中风险） | 批量 delete / cleanup / import(merge) | 一次确认 + 自动备份 |
| L4（高风险） | delete --all / --purge / import(replace) | 二次确认 + 自动备份 + 冷却 3 秒 |

**Agent 行为映射**：

```
L1: Agent 直接执行，展示结果
L2: Agent 展示目标，用户确认后执行
L3: Agent 展示列表 + 影响范围，用户确认后执行，报告备份路径
L4: Agent 警告 + 展示列表 + 影响范围 + 二次确认，执行后报告
```

---

## 6. Agent 行为规范（SKILL.md / Rules 核心）

### 6.1 查看记忆

```
当用户询问"记了什么/有哪些记忆/记忆状态"时：
1. 先调用 stats 获取概览
2. 根据用户需求调用 list（按时间/关键字）
3. 将 JSON 结果转为自然语言展示
```

### 6.2 删除记忆

```
当用户要求"删除/清理/去掉 XX 记忆"时：
1. 先调用 list 获取匹配记录
2. 将结果展示给用户：
   - "找到 N 条关于 XX 的记忆，列表如下：..."
   - "确认删除吗？（默认软删除，可恢复）"
3. 用户明确确认后调用 delete --confirm
4. 如果匹配 >10 条（L3），再次提醒数量
5. 删除后报告："已软删除 N 条记录（如需恢复可执行 restore）。"
```

### 6.3 恢复记忆

```
当用户说"恢复刚才删的"/"撤销删除"时：
1. 调用 list --include-deleted 找到最近的软删除记录
2. 展示给用户确认
3. 调用 restore 恢复
```

### 6.4 修改记忆

```
当用户要求"改一下那条记录"时：
1. 先调用 list --id 或 list --keyword 找到目标
2. 展示当前内容
3. 用户说明修改内容后调用 edit
4. 报告修改结果
```

### 6.5 配置变更路由

```
当用户说"把加载天数调成 3 天"/"换个模型"/"日志级别改 DEBUG"时：
→ 路由到 manage_memory.py config set（而非数据操作命令）
→ 参见"统一配置入口设计"文档
```

### 6.6 静默规则

```
- 管理操作的执行命令不在回复中暴露（不展示 python3 manage_memory.py ...）
- 只向用户展示结果和确认请求
- 异常时提供友好说明而非原始错误码
```

---

## 7. 安全与一致性

### 7.1 软删除机制

**默认删除为软删除**，在 JSONL 条目中添加标记字段：

```json
{
  "id": "log-103005-a1b2",
  "type": "fact",
  "content": "Redis 缓存方案选型",
  "deleted_at": "2026-02-19T12:05:00Z",
  "deleted_by": "agent"
}
```

- `load_memory.py` 和 `search_memory.py` 加载时过滤 `deleted_at != null`
- `list` 默认不显示已删除记录，`--include-deleted` 可查看
- `cleanup --purge-deleted` 物理清除已标记的条目

### 7.2 自动备份

所有 L3+ 操作执行前，自动快照受影响文件：

```
.cursor/skills/memory-data/backups/YYYY-MM-DD-HHMMSS/
├── daily/2026-02-15.jsonl    ← 仅备份受影响的文件
└── sessions.jsonl
```

### 7.3 原子写入

JSONL 修改采用：写临时文件 → `fsync` → `os.replace()` 原子替换。

### 7.4 并发锁

```
.cursor/skills/memory-data/.manage.lock
```
管理工具与 Hook（sync_and_cleanup.py）共享文件锁，超时 10 秒。

### 7.5 索引同步策略

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| `immediate`（默认） | 写操作后立即触发增量 sync_index | 单条 edit、小批量 delete |
| `deferred` | 写操作成功后返回，后台异步重建 | 大批量 cleanup |
| `--no-sync` | 显式跳过 | 连续多次写入后手动 rebuild |

### 7.6 审计日志

所有写操作记录到审计文件：

```
.cursor/skills/memory-data/audit/operations.jsonl
```

每条记录包含：

| 字段 | 说明 |
|------|------|
| `op_id` | 操作唯一 ID |
| `timestamp` | 时间戳 |
| `actor` | 执行者（user/agent/system） |
| `command` | 子命令（delete/edit/cleanup/...） |
| `scope` | 操作范围 |
| `before_count` / `after_count` | 操作前后记录数 |
| `backup_path` | 备份路径（如有） |
| `success` | 是否成功 |
| `error` | 错误信息（如有） |

---

## 8. 实现方案

### 新增文件

```
scripts/manage_memory.py     # 统一管理入口
lib/file_lock.py             # 文件锁
```

### lib/jsonl.py 新增

```python
def filter_entries(daily_dir, sessions_path, predicate, scope) -> list
def soft_delete_entries(daily_dir, sessions_path, predicate, scope) -> dict
def purge_entries(daily_dir, sessions_path, predicate, scope) -> dict
def restore_entries(daily_dir, sessions_path, predicate) -> dict
def update_entry(daily_dir, sessions_path, entry_id, updates) -> dict
def count_by_type(daily_dir) -> dict
def date_range_summary(daily_dir) -> dict
```

### Agent 配置更新

- `SKILL.md`：增加记忆管理章节 + 风险分级说明
- `memory-rules.mdc`：增加删除确认流程 + 配置路由 + 恢复指引

---

## 9. 作用范围默认值

不同命令的 `--scope` 默认值不同，防止误操作：

| 命令 | 默认 scope | 理由 |
|------|-----------|------|
| `list` | `all` | 查看场景用户想看全局 |
| `delete` | `daily` | 避免误删会话摘要 |
| `edit` | `daily` | 同上 |
| `cleanup` | `daily` | 同上 |
| `export` | `all` | 备份应完整 |
| `import` | `all` | 恢复应完整 |
| `restore` | `daily` | 恢复范围与删除一致 |

修改 sessions 必须显式 `--scope sessions` 或 `--scope all`。

---

## 10. 验收标准

| # | 标准 |
|---|------|
| 1 | 用户说"看看记忆"→ Agent 展示统计和列表 |
| 2 | 用户说"删掉 X 记忆"→ Agent 先预览再确认 |
| 3 | 软删除后搜索不返回，restore 后恢复 |
| 4 | 物理删除（purge）自动生成备份 |
| 5 | 并发写入不损坏文件 |
| 6 | export → import 数据无损 |
| 7 | doctor 能检出异常并给出建议 |
| 8 | L3/L4 操作确认链路完整 |
| 9 | 分页在并发写入下结果稳定（snapshot） |
| 10 | 审计日志记录所有写操作 |

---

## 11. 实施优先级

### 第一批（核心）

| # | 内容 | 理由 |
|---|------|------|
| 1 | `list` + `stats` | 查看能力，删除的前置步骤 |
| 2 | `delete`（软删除）+ `restore` | 最紧迫缺失 + 恢复闭环 |
| 3 | `rebuild-index` | delete 配套 + 故障自愈 |
| 4 | 文件锁 + 原子写入 + 自动备份 | 安全基础 |
| 5 | 风险分级 + SKILL.md / Rules | Agent 行为指导 |

### 第二批（增强）

| # | 内容 |
|---|------|
| 6 | `export` + `import` |
| 7 | `cleanup`（含 purge-deleted） |
| 8 | `doctor`（含阈值告警） |
| 9 | 审计日志 |

### 第三批（完善）

| # | 内容 |
|---|------|
| 10 | `edit` |
| 11 | 分页 snapshot 一致性 |
| 12 | deferred 索引同步模式 |
