# 修复后缺陷复核报告

> 日期：2026-02-19  
> 复核范围：`skills/memory-skill` 当前实现 + 外部独立测试 `tests/standalone-memory-skill`  
> 对照基线：`设计/2026-02-19-01-Skill实现与设计缺陷审查.md`

---

## 1. 复核结论

前一版报告中的核心代码缺陷已大部分修复，当前状态如下：

| 缺陷项 | 之前状态 | 当前状态 | 结论 |
|------|------|------|------|
| 事实写入与加载链路断裂 | 存在 | `load_memory.py` 已从 `daily/` 加载事实 | **已修复** |
| embedding 缓存路径判定错误 | 存在 | 已使用 `models--...` 缓存目录判定 | **已修复** |
| partial 衰减取样“取旧不取新” | 存在 | `jsonl.py` 已改为取最新 N 条 | **已修复** |
| `ts_id` 秒级冲突风险 | 存在 | 已改为毫秒 + 随机后缀 | **已修复** |
| global 安装相对路径风险 | 存在 | `init.py --global` 已使用绝对 skill 路径 | **已修复** |
| 测试假阳性断言 | 存在 | 相关恒真断言已移除 | **已修复** |
| 设计文档与实现不一致 | 存在 | 设计文档仍有多处旧描述 | **部分未修复** |

---

## 2. 已确认修复点

## 2.1 记忆主链路闭环

- `load_memory.py` 已改为读取 `daily/`（`read_recent_facts_from_daily`），不再依赖 `facts.jsonl` 才能召回。
- `sessionEnd` 新增 `sync_and_cleanup.py`，在会话结束后自动执行索引同步与清理。

## 2.2 Hook 体系更新

- `stop` Hook 已改为 `prompt_session_save.py`
- 新增 `sessionEnd` Hook 指向 `sync_and_cleanup.py`
- `.cursor/hooks.json` 与 `templates/hooks.json` 均已体现

## 2.3 唯一性与衰减策略

- `utils.ts_id()` 使用 `HHMMSSmmm-rand4`，高频调用不再重复
- `jsonl.py` partial 桶选择已按“最新 N 条”逻辑实现

## 2.4 初始化路径策略

- `init.py` 在 `--global` 模式下不再走基于项目根目录的相对路径策略，降低跨项目路径不稳定风险

---

## 3. 仍存在的问题

## 3.1 设计文档尚未完全对齐实现（主要残留）

当前 `设计/` 目录中仍可检索到大量历史描述（如 `.memory-data`、`save_session.py`、`echo >>` 写入范式等），与现代码实现有偏差。  
这属于**文档层缺陷**，不阻塞运行，但会影响后续维护与协作准确性。

建议：

1. 统一把路径描述迁移到 `.cursor/skills/memory-data`
2. 把 stop Hook 名称统一为 `prompt_session_save.py`
3. 把会话结束同步机制补充到生命周期文档（`sessionEnd`）
4. 把写入示例统一成 `save_fact.py` / `save_summary.py`

---

## 4. 本轮验证结果

本轮外部独立多维度测试已通过：

- 用例总数：11
- 通过：11
- 失败：0
- 报告：`tests/standalone-memory-skill/2026-02-19-02-多维度测试结果.md`

覆盖维度：

1. 单元行为（ID 唯一性、衰减策略、CLI 输出）
2. Hook 协议（sessionStart/preCompact/stop）
3. 端到端链路（daily 召回、sessionEnd 同步后可搜索）
4. 安装路径逻辑（global/local）

---

## 5. 总结

代码层核心缺陷已基本修复，系统从“可运行但有主链路风险”提升为“链路完整、测试可验证”的状态。  
当前剩余主要工作是**文档同步收口**，建议作为下一步单独批次处理。

