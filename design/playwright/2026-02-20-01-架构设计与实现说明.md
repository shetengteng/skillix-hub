# Playwright Skill 架构设计与实现说明

> 日期：2026-02-20
> 状态：已完成实现

## 1. 项目背景

将 Playwright MCP（Model Context Protocol）的 48 个浏览器自动化工具完整复刻为 Cursor Agent Skill，去除 MCP 协议依赖，通过 CLI 直接调用。

## 2. 架构设计

### 2.1 调用链

```
AI Agent → Shell (node tool.js <command> <json>) → Tool Handler → Playwright-core → Browser
```

对比原始 MCP：
```
AI Agent → MCP Client → MCP Server (stdio/http) → Tool Handler → Playwright → Browser
```

### 2.2 目录结构

```
skills/playwright/
├── SKILL.md                     # AI 指令文件（中文）
├── package.json                 # 依赖声明（playwright-core）
├── tool.js                      # 统一 CLI 入口
├── lib/
│   ├── config.js                # 配置管理
│   ├── response.js              # 响应构建器（纯 JSON 输出）
│   ├── utils.js                 # 工具函数
│   ├── browser-manager.js       # 浏览器持久化管理
│   ├── context.js               # 浏览器上下文管理
│   └── tab.js                   # 标签页管理
├── tools/                       # 25 个工具模块（共 68 个导出函数）
│   ├── common.js                # close / resize
│   ├── snapshot.js              # snapshot / click / drag / hover / selectOption / check / uncheck
│   ├── navigate.js              # navigate / goBack / goForward / reload
│   ├── keyboard.js              # pressKey / type / pressSequentially / keydown / keyup
│   ├── mouse.js                 # mouseMove / mouseClick / mouseDrag / mouseDown / mouseUp / mouseWheel
│   ├── form.js                  # fillForm
│   ├── evaluate.js              # evaluate
│   ├── screenshot.js            # screenshot
│   ├── wait.js                  # waitFor
│   ├── tabs.js                  # tabs (list/new/close/select)
│   ├── console.js               # consoleMessages / consoleClear
│   ├── network.js               # networkRequests / networkClear
│   ├── dialogs.js               # handleDialog
│   ├── files.js                 # fileUpload
│   ├── cookies.js               # cookieList / cookieGet / cookieSet / cookieDelete / cookieClear
│   ├── storage.js               # storageState / setStorageState
│   ├── webstorage.js            # localStorage + sessionStorage (10 个工具)
│   ├── route.js                 # route / routeList / unroute
│   ├── pdf.js                   # pdf
│   ├── tracing.js               # tracingStart / tracingStop
│   ├── video.js                 # startVideo / stopVideo
│   ├── verify.js                # verifyElement / verifyText / verifyList / verifyValue / generateLocator
│   ├── devtools.js              # devtoolsStart
│   ├── install.js               # install
│   ├── config.js                # getConfig
│   └── runCode.js               # runCode
└── references/
    └── tools-api.md             # 完整工具 API 参考文档（中文）
```

## 3. 核心模块说明

### 3.1 browser-manager.js - 浏览器持久化

MCP 通过常驻服务进程保持浏览器实例。Skill 采用不同策略：

- 启动浏览器时开启 CDP（Chrome DevTools Protocol）远程调试端口
- 将 WebSocket endpoint 和 PID 写入 `/tmp/playwright-skill/browser-state.json`
- 后续调用通过 `connectOverCDP` 重新连接到已有浏览器
- 提供 `start` / `stop` / `status` 元命令管理生命周期

### 3.2 context.js - 浏览器上下文

从 MCP 的 `context.ts` 简化改造：
- 去掉 `BrowserContextFactory` 抽象
- 去掉 `SessionLog`、`ClientInfo` 等 MCP 特有概念
- 保留核心功能：标签页管理、路由管理

### 3.3 tab.js - 标签页管理

从 MCP 的 `tab.ts` 改造：
- 保留 `_snapshotForAI()` 调用（已验证可用）
- 保留 `aria-ref` 选择器系统（已验证可用）
- 自动刷新快照：`refLocator` 调用前自动执行 `_snapshotForAI()` 以确保 ref 有效
- 保留控制台消息、网络请求、对话框、文件选择器的事件监听

### 3.4 response.js - 响应构建

完全重写，输出纯 JSON 到 stdout：
```json
{
  "result": "操作结果文本",
  "snapshot": "无障碍树快照",
  "tabs": ["标签页列表"],
  "code": "生成的 Playwright 代码",
  "error": "错误信息（如有）"
}
```

### 3.5 tool.js - CLI 入口

统一命令入口，职责：
1. 解析命令和 JSON 参数
2. 处理元命令（start/stop/status/list）
3. 连接或启动浏览器
4. 创建 Context 和 Response
5. 分发到对应 tool handler
6. 序列化输出

## 4. 关键技术决策

### 4.1 使用 playwright-core 内部 API

经实测验证，以下 API 均可通过 `playwright-core` npm 包直接使用：

| API | 用途 |
|-----|------|
| `page._snapshotForAI()` | 获取无障碍快照（带 ref） |
| `page.locator('aria-ref=xxx')` | 通过 ref 定位元素 |
| `locator._resolveSelector()` | 解析选择器 |
| `asLocator()` | 选择器转人类可读形式 |
| `formatObject()` | 对象格式化 |
| `escapeWithQuotes()` | 字符串转义 |

### 4.2 浏览器持久化方案

选择 CDP 连接而非 WebSocket 连接，原因：
- Chrome 原生支持 `--remote-debugging-port`
- `connectOverCDP` 比 `connect` 更稳定
- 不需要额外的 WebSocket server

### 4.3 CommonJS 而非 ESM

选择 CommonJS 格式，原因：
- `playwright-core/lib/*` 的内部模块使用 CommonJS
- 避免 ESM/CJS 互操作问题
- Node.js 原生支持，无需构建步骤

## 5. 与 MCP 的差异

| 方面 | MCP | Skill |
|------|-----|-------|
| 协议 | MCP SDK (stdio/SSE) | CLI (stdout JSON) |
| 进程模型 | 常驻服务 | 按需连接 |
| 浏览器管理 | 服务内存 | CDP + 状态文件 |
| 工具定义 | `defineTool` / `defineTabTool` | 普通函数导出 |
| 响应格式 | `CallToolResult` | 纯 JSON |
| Token 消耗 | 工具定义注入上下文 | 按需加载 |

## 6. 已验证功能

端到端测试验证通过：
- `navigate` → 成功导航到 example.com，返回完整快照
- `click` → 成功点击链接，页面跳转到 iana.org
- `snapshot` → 正确返回无障碍树
- `tabs` → 正确列出标签页
- `goBack` → 成功返回上一页
- `consoleMessages` → 正确返回控制台消息
- `cookieList` → 正确列出 Cookie
- `getConfig` → 正确返回配置
- `start` / `stop` / `status` → 浏览器生命周期管理正常
