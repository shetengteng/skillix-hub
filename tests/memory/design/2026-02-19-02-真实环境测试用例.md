# Memory Skill 真实 Cursor 环境测试用例

> **日期**: 2026-02-19
> **前提**: Memory Skill 已通过 `init` 脚本安装到 Cursor 项目中
> **源码**: `skills/memory/scripts/`
> **数据目录**: `.cursor/skills/memory-data/`

---

## 1. 初始化验证

### TC-1.1 一键初始化

```bash
cd <your-project>
python3 <skillix-hub>/skills/memory/scripts/service/init/index.py
```

**验证点**:
- [ ] `.cursor/hooks.json` 已创建，包含 sessionStart / preCompact / stop 三个 Hook
- [ ] `.cursor/rules/memory-rules.mdc` 已创建
- [ ] `.cursor/skills/memory-data/MEMORY.md` 已创建
- [ ] `.cursor/skills/memory-data/daily/` 目录已创建

```bash
cat .cursor/hooks.json | python3 -m json.tool
cat .cursor/rules/memory-rules.mdc | head -5
ls -la .cursor/skills/memory-data/
```

---

## 2. Hook 脚本独立验证

### TC-2.1 load_memory（sessionStart Hook）

```bash
echo '{"type":"sessionStart","conversation_id":"tc-001","workspace_roots":["'$(pwd)'"]}' \
  | python3 <skillix-hub>/skills/memory/scripts/service/hooks/load_memory.py
```

**预期**: JSON 输出包含 `additional_context` 字段，内容为 MEMORY.md + 近期事实 + 上次会话摘要。

**验证**:
- [ ] 输出是合法 JSON
- [ ] `additional_context` 包含 MEMORY.md 内容
- [ ] daily/ 目录下当天 JSONL 新增 `session_start` 记录

### TC-2.2 flush_memory（preCompact Hook）

```bash
echo '{"type":"preCompact","conversation_id":"tc-001","workspace_roots":["'$(pwd)'"],"context_usage_percent":85,"message_count":30}' \
  | python3 <skillix-hub>/skills/memory/scripts/service/hooks/flush_memory.py
```

**预期**: JSON 输出包含 `user_message` 字段，以 `[Memory Flush]` 开头。

**验证**:
- [ ] 输出包含 `user_message`
- [ ] 消息包含使用率 85% 和消息数 30
- [ ] 包含 `save_fact.py` 调用示例
- [ ] 包含当前会话 ID

### TC-2.3 prompt_session_save（stop Hook - completed）

```bash
echo '{"type":"stop","conversation_id":"tc-001","workspace_roots":["'$(pwd)'"],"status":"completed"}' \
  | python3 <skillix-hub>/skills/memory/scripts/service/hooks/prompt_session_save.py
```

**预期**: JSON 输出包含 `followup_message`，以 `[Session Save]` 开头。

### TC-2.4 prompt_session_save（stop Hook - interrupted）

```bash
echo '{"type":"stop","conversation_id":"tc-001","status":"interrupted"}' \
  | python3 <skillix-hub>/skills/memory/scripts/service/hooks/prompt_session_save.py
```

**预期**: 输出为空 JSON `{}`。

---

## 3. 记忆操作验证

### TC-3.1 保存事实

```bash
python3 <skillix-hub>/skills/memory/scripts/service/memory/save_fact.py \
  --content "项目决定使用 PostgreSQL 作为主数据库" \
  --type W \
  --entities "PostgreSQL,数据库" \
  --confidence 0.95 \
  --session "tc-manual-001"
```

**验证**:
- [ ] 输出包含 `id` 字段
- [ ] `.cursor/skills/memory-data/daily/<today>.jsonl` 新增一行
- [ ] 该行 JSON 包含 content / type / entities / confidence

```bash
tail -1 .cursor/skills/memory-data/daily/$(date +%Y-%m-%d).jsonl | python3 -m json.tool
```

### TC-3.2 保存会话摘要

```bash
python3 <skillix-hub>/skills/memory/scripts/service/memory/save_summary.py \
  --topic "数据库选型讨论" \
  --summary "讨论了 MySQL 和 PostgreSQL 的优劣，最终决定使用 PostgreSQL" \
  --decisions "使用PostgreSQL,不用MySQL" \
  --todos "创建数据库Schema" \
  --session "tc-manual-001"
```

**验证**:
- [ ] `.cursor/skills/memory-data/sessions.jsonl` 新增一行
- [ ] 该行包含 topic / summary / decisions / todos

### TC-3.3 搜索记忆

```bash
python3 <skillix-hub>/skills/memory/scripts/service/memory/search_memory.py "数据库"
```

**验证**:
- [ ] 输出包含之前保存的 PostgreSQL 事实
- [ ] 结果按相关性排序

### TC-3.4 管理记忆

```bash
# 列出所有记忆
python3 <skillix-hub>/skills/memory/scripts/service/manage/index.py list

# 按关键词过滤
python3 <skillix-hub>/skills/memory/scripts/service/manage/index.py list --keyword "数据库"

# 查看统计
python3 <skillix-hub>/skills/memory/scripts/service/manage/index.py stats

# 查看配置
python3 <skillix-hub>/skills/memory/scripts/service/manage/index.py config get embedding.model
```

**验证**:
- [ ] list 返回 JSON 格式的记忆列表
- [ ] stats 返回磁盘使用和记录数统计
- [ ] config 返回当前配置值

---

## 4. Cursor 真实 Hook 集成测试

### TC-4.1 新会话自动加载记忆

**步骤**:
1. 确保 `.cursor/hooks.json` 配置了 sessionStart Hook
2. 在 `.cursor/skills/memory-data/MEMORY.md` 中写入测试内容：`用户偏好 Python，项目使用 FastAPI`
3. 关闭当前对话
4. 开始新对话，问 Agent："我们项目用的什么框架？"

**预期**: Agent 能回答 "FastAPI"（来自记忆加载）

### TC-4.2 会话结束自动保存

**步骤**:
1. 与 Agent 讨论一个技术决策（如"我们决定用 Redis 做缓存层"）
2. 完成任务后 Agent 应触发 stop Hook
3. 检查 sessions.jsonl

```bash
tail -1 .cursor/skills/memory-data/sessions.jsonl | python3 -m json.tool
```

**预期**: 新增一条包含 Redis 缓存决策的会话摘要

### TC-4.3 跨会话记忆验证

**步骤**:
1. 在会话 A 中讨论并保存了 "使用 Redis 做缓存" 的决策
2. 关闭会话 A
3. 开始新会话 B
4. 问 "我们之前决定用什么做缓存？"

**预期**: Agent 能正确回答 "Redis"

---

## 5. 边界场景

### TC-5.1 空项目初始状态

在一个没有任何记忆数据的项目中测试 load_memory，应该只返回空的 MEMORY.md 内容。

### TC-5.2 大量记忆数据

保存 100+ 条事实后，验证：
- load_memory 加载时间 < 2s
- search_memory 搜索响应 < 5s
- list 分页功能正常

### TC-5.3 并发写入安全

同时运行两个 save_fact 命令，验证：
- 两条记录都成功写入
- JSONL 文件格式未损坏（FileLock 保护）

---

## 6. 数据完整性检查

```bash
# 验证所有 JSONL 文件格式
for f in .cursor/skills/memory-data/daily/*.jsonl .cursor/skills/memory-data/sessions.jsonl; do
  if [ -f "$f" ]; then
    echo "=== $f ==="
    python3 -c "
import json
with open('$f') as fh:
    lines = fh.readlines()
    valid = sum(1 for l in lines if l.strip())
    errors = []
    for i, l in enumerate(lines, 1):
        if l.strip():
            try: json.loads(l)
            except: errors.append(i)
    print(f'  总行数: {valid}, 错误行: {errors if errors else \"无\"}')
"
  fi
done
```
