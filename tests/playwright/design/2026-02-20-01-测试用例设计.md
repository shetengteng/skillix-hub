# Playwright Skill 测试用例设计

> 日期：2026-02-20
> 状态：已实现

## 1. 测试策略

采用三层测试结构，参考 memory skill 的测试组织方式：

```
tests/playwright/
├── run_tests.js          # 统一测试执行器
├── src/
│   ├── unit/             # 单元测试（不需要浏览器）
│   ├── integration/      # 集成测试（需要浏览器，测试单个功能）
│   └── e2e/              # 端到端测试（完整工作流）
├── reports/              # 自动生成的测试报告
└── design/               # 测试设计文档
```

## 2. 单元测试

### 2.1 test_config.js

测试 `lib/config.js` 模块：

| 用例 | 说明 |
|------|------|
| test_defaultConfig | 验证默认配置值（browser=chromium, channel=chrome, timeouts） |
| test_overrides | 验证参数覆盖机制 |
| test_envOverrides | 验证环境变量覆盖（PLAYWRIGHT_SKILL_BROWSER, PLAYWRIGHT_SKILL_HEADLESS） |
| test_ensureDir | 验证目录创建功能 |
| test_outputFile | 验证输出文件路径生成 |

### 2.2 test_response.js

测试 `lib/response.js` 模块：

| 用例 | 说明 |
|------|------|
| test_basicResult | 验证基本结果和代码输出 |
| test_errorResult | 验证错误信息输出 |
| test_multipleResults | 验证多个结果合并 |

### 2.3 test_tool_registry.js

测试 `tool.js` 的工具注册和命令解析：

| 用例 | 说明 |
|------|------|
| test_listCommand | 验证 `list` 命令返回工具数组 |
| test_expectedToolsPresent | 验证 27 个关键工具已注册 |
| test_unknownCommand | 验证未知命令返回错误 |
| test_invalidJson | 验证无效 JSON 参数返回错误 |
| test_noCommand | 验证无命令时返回用法提示 |

## 3. 集成测试

### 3.1 test_browser_lifecycle.js

测试浏览器生命周期管理：

| 用例 | 说明 |
|------|------|
| test_startAndStatus | 验证 start 启动浏览器，status 显示 running |
| test_stopAndStatus | 验证 stop 关闭浏览器，status 显示 not running |
| test_doubleStart | 验证重复 start 检测到已运行浏览器 |

## 4. 端到端测试

### 4.1 test_navigation_flow.js

测试完整的浏览器自动化工作流：

| 用例 | 说明 |
|------|------|
| test_navigateAndSnapshot | 导航到 example.com，验证快照包含 Example Domain 和 ref |
| test_clickLink | 获取快照中的 ref，点击 Learn more 链接 |
| test_tabs | 验证标签页列表功能 |
| test_consoleAndNetwork | 验证控制台消息和网络请求获取 |
| test_cookies | 验证 Cookie 列表功能 |

## 5. 测试环境

- 所有测试使用 headless 模式（`PLAYWRIGHT_SKILL_HEADLESS=true`）
- 测试目标网站：example.com（稳定、快速、无需认证）
- 每个测试文件独立运行，自行管理浏览器生命周期
- 测试报告自动生成到 `reports/` 目录，带日期前缀

## 6. 测试覆盖范围

### 已覆盖

| 模块 | 覆盖的工具/功能 |
|------|----------------|
| config.js | 默认配置、参数覆盖、环境变量、目录创建、文件路径 |
| response.js | 文本结果、错误结果、多结果合并 |
| tool.js | 工具注册、命令解析、错误处理 |
| browser-manager.js | 启动、停止、状态检查、重复启动检测 |
| navigate.js | 导航、快照返回 |
| snapshot.js | 快照获取、ref 系统、跨进程持久化 |
| click (snapshot.js) | ref 定位、点击、代码生成 |
| tabs.js | 标签页列表 |
| console.js | 控制台消息获取 |
| network.js | 网络请求获取 |
| cookies.js | Cookie 列表 |

### 已补充覆盖（integration 测试）

| 测试文件 | 覆盖的工具 |
|---------|-----------|
| test_navigation_tools.js | navigate, snapshot, reload, goBack, goForward |
| test_interaction_tools.js | click, hover, pressKey, mouseMove, mouseClick, mouseWheel, waitFor, resize |
| test_observe_tools.js | consoleMessages, consoleClear, networkRequests, networkClear, screenshot, tabs (list/new/close/select) |
| test_data_tools.js | cookieList/Get/Set/Delete/Clear, localStorage (Set/Get/Delete/List/Clear), sessionStorage (Set/Get/Delete/List/Clear), evaluate, getConfig, route, routeList, unroute |
| test_advanced_tools.js | runCode, verifyText, verifyElement, generateLocator, tracingStart, close |

### 未覆盖（需要特定环境或交互）

- form / fillForm（需要可交互的表单页面）
- dialogs / handleDialog（需要触发对话框）
- files / fileUpload（需要触发文件选择器）
- drag（需要可拖拽元素）
- pdf（需要 headless Chromium 特定配置）
- video / startVideo / stopVideo（需要录制配置）
- tracingStop（跨进程状态限制）
- storageState / setStorageState（需要持久化文件）
- install / devtools（系统级操作）
