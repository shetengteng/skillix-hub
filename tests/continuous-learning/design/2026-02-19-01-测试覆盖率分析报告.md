# Continuous Learning Skill 测试覆盖率分析报告

> **日期**: 2026-02-19
> **基准**: 75 用例，75 通过，0 跳过
> **源码位置**: `skills/continuous-learning/scripts/`
> **测试位置**: `tests/continuous-learning/src/`

---

## 1. 测试目录结构

```
tests/continuous-learning/
├── src/                        # 测试源码
│   ├── __init__.py
│   ├── run_all_tests.py        # 统一执行器
│   ├── test_analyze.py         # 行为分析
│   ├── test_instinct.py        # 本能管理
│   ├── test_observe.py         # 观察记录
│   ├── test_setup_rule.py      # 规则设置
│   └── test_utils.py           # 工具函数
├── design/                     # 测试设计文档
└── reports/                    # 测试报告（自动生成）
```

---

## 2. 覆盖率矩阵

### 2.1 scripts/ — 源码模块

| 源文件 | 测试文件 | 用例数 | 覆盖说明 |
|--------|----------|--------|----------|
| utils.py | test_utils.py | 15 | 时间工具、Pending Session 管理、本能文件解析/生成、技能索引、配置 |
| observe.py | test_observe.py | 13 | --init 初始化、--record 记录、--finalize 结束、命令行接口 |
| analyze.py | test_analyze.py | 14 | 观察分析、用户纠正检测、错误修复检测、工具偏好检测、命令行接口 |
| instinct.py | test_instinct.py | 16 | 本能创建/更新/删除/列出、技能检查、演化逻辑、命令行接口 |
| setup_rule.py | test_setup_rule.py | 17 | 规则配置、助手检测、项目根目录、规则增删改查、命令行接口 |

### 2.2 按测试类型

| 类型 | 用例数 | 说明 |
|------|--------|------|
| 单元测试 | 44 | 纯函数、配置解析、数据处理 |
| 功能测试 | 19 | 完整功能流程（创建/更新/删除本能等） |
| 命令行测试 | 12 | subprocess 调用脚本，验证 CLI 契约 |

---

## 3. 沙盒化方案

### 3.1 数据目录隔离

通过 `SandboxMixin` 实现统一沙盒：

```python
class SandboxMixin:
    def _setup_sandbox(self):
        self._sandbox_dir = tempfile.mkdtemp()
        self._sandbox_path = Path(self._sandbox_dir)
        utils_module._data_dir_override = self._sandbox_path / "continuous-learning-data"
        utils_module._data_dir_override.mkdir(parents=True, exist_ok=True)
        ensure_data_dirs()

    def _teardown_sandbox(self):
        utils_module._data_dir_override = self._original_override
        shutil.rmtree(self._sandbox_dir, ignore_errors=True)
```

### 3.2 子进程隔离

命令行测试通过环境变量传递沙盒路径：

| 环境变量 | 用途 |
|----------|------|
| `CL_SANDBOX_DATA_DIR` | 覆写 `get_data_dir()` 返回值 |
| `CL_SANDBOX_PROJECT_ROOT` | 覆写 `get_project_root()` 返回值 |

### 3.3 项目根目录隔离（test_setup_rule.py）

```python
self._sandbox_path / ".cursor" / "rules"  # 模拟项目结构
self._sandbox_path / ".git"               # 模拟 git 仓库
setup_rule_module.get_project_root = lambda: self._sandbox_path
```

**隔离保证**：
- 不写入 `.cursor/` 或 `.cursor/rules/` 目录
- 不写入用户主目录
- 子进程也在沙盒中运行
- tearDown 自动清理

---

## 4. 运行方式

```bash
cd tests/continuous-learning/src
python3 run_all_tests.py
```
