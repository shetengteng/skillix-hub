# Behavior Prediction Skill 测试覆盖率分析报告

> **日期**: 2026-02-19
> **基准**: 94 用例，94 通过，0 跳过
> **源码位置**: `skills/behavior-prediction/scripts/`
> **测试位置**: `tests/behavior-prediction/src/`

---

## 1. 测试目录结构

```
tests/behavior-prediction/
├── src/                        # 测试源码
│   ├── __init__.py
│   ├── run_all_tests.py        # 统一执行器
│   ├── test_auto_execute.py    # 自动执行评估
│   ├── test_extract_patterns.py # 模式提取
│   ├── test_get_predictions.py # 预测功能
│   ├── test_hook.py            # 会话 Hook
│   ├── test_record_session.py  # 会话记录
│   ├── test_user_profile.py    # 用户画像
│   └── test_utils.py           # 工具函数
├── design/                     # 测试设计文档
└── reports/                    # 测试报告（自动生成）
```

---

## 2. 覆盖率矩阵

### 2.1 scripts/ — 源码模块

| 源文件 | 测试文件 | 用例数 | 覆盖说明 |
|--------|----------|--------|----------|
| utils.py | test_utils.py | 20 | 数据目录、JSON 读写、配置加载、时间工具、数据保留策略 |
| hook.py | test_hook.py | 9 | --init 初始化、--finalize 会话结束、集成测试 |
| record_session.py | test_record_session.py | 8 | 会话记录、ID 格式、索引更新、多次会话递增 |
| get_predictions.py | test_get_predictions.py | 11 | 预测下一步、置信度计算、建议生成、上下文调整 |
| extract_patterns.py | test_extract_patterns.py | 10 | 模式检测、序列识别、项目推断、技术分类 |
| user_profile.py | test_user_profile.py | 11 | 画像加载/更新、工作风格分析、AI 摘要 |
| get_predictions.py (auto_execute) | test_auto_execute.py | 25 | 自动执行配置、评估函数、命令生成、安全性、边界条件 |

### 2.2 按测试类型

| 类型 | 用例数 | 说明 |
|------|--------|------|
| 单元测试 | 79 | 各模块独立函数测试 |
| 集成测试 | 15 | Hook 生命周期、预测集成、画像集成 |

---

## 3. 沙盒化方案

所有测试使用 `tempfile.mkdtemp()` 创建临时目录，通过覆写 `utils.DATA_DIR` 隔离数据操作：

```python
def setUp(self):
    self.temp_dir = tempfile.mkdtemp()
    import utils
    self.original_data_dir = utils.DATA_DIR
    utils.DATA_DIR = Path(self.temp_dir) / "behavior-prediction-data"
    utils.ensure_data_dirs()

def tearDown(self):
    import utils
    utils.DATA_DIR = self.original_data_dir
    shutil.rmtree(self.temp_dir, ignore_errors=True)
```

**隔离保证**：
- 不写入 `.cursor/` 目录
- 不写入用户主目录
- 每个测试用例独立数据空间
- tearDown 自动清理

---

## 4. 运行方式

```bash
cd tests/behavior-prediction/src
python3 run_all_tests.py
```
